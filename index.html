<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Logรญstica</title>
<meta name="theme-color" content="#111827">
<link rel="manifest" href="manifest.json">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">


<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<style>
:root {
ย /* Paleta de Colores Profesional */
ย --bg-dark: #111827;ย ย ย /* Azul Marino Oscuro (Fondo Principal) */
ย --bg-medium: #1F2937;ย ย /* Gris Azulado Oscuro (Tarjetas y Paneles) */
ย --bg-light: #374151;ย ย ย/* Gris Azulado Claro (Bordes, Hover) */
ย --text-light: #F9FAFB;ย ย/* Blanco Hueso (Texto Principal) */
ย --text-medium: #9CA3AF; /* Gris Claro (Texto Secundario, Etiquetas) */
ย --text-dark: #1F2937;ย ย /* Texto para fondos claros */
ย --accent-blue: #3B82F6;ย ย/* Azul Principal (Botones, รnfasis) */
ย --accent-blue-hover: #2563EB;
ย --accent-green: #10B981;ย /* Verde Esmeralda (รxito, Liberado) */
ย --accent-red: #EF4444;ย ย /* Rojo (Peligro, Rechazado) */
ย --accent-orange: #F59E0B; /* รmbar (Advertencia, En Proceso) */
ยย
ย /* Estilos de LED */
ย --led-size: 50px;
ย --led-gap: 16px;
ย --led-off-core: #2d3748;
ย --led-off-edge: #1a202c;
ย --glow-green: rgba(16, 185, 129, 0.7);
ย --glow-red: rgba(239, 68, 68, 0.7);
ย --glow-orange: rgba(245, 158, 11, 0.7);
ย --blink-duration: 1.2s;

ย /* Tipografรญa */
ย --font-family: 'Poppins', Arial, Helvetica, sans-serif;
ย --titulo-size: clamp(36px, 6vw, 72px);

ย /* Otros */
ย --border-radius-md: 16px; /* Aumentamos el radio para un look mรกs moderno */
ย --border-radius-sm: 10px;
ย --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
ย --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
}

* { box-sizing: border-box; }

html, body {
ย height: 100%;
ย margin: 0;
ย font-family: var(--font-family);
ย color: var(--text-light);
ย background-color: var(--bg-dark);
ย /* Fondo degradado para que el efecto glass se aprecie mejor */
ย background-image:ย
ย ย radial-gradient(at 47% 33%, hsl(225, 39%, 30%) 0, transparent 59%),ย
ย ย radial-gradient(at 82% 65%, hsl(253, 16%, 7%) 0, transparent 55%);
}

.pantalla {
ย display: none;
ย width: 100%;
ย min-height: 100vh;
ย padding: 20px;
ย transition: opacity 0.5s ease-out;
}
.pantalla.activa { display: flex; flex-direction: column; }

/* ================= BRANDING HEADER ================= */
.brand-title {
ย font-family: 'Times New Roman', Times, serif;
ย color: white;
ย font-size: clamp(22px, 3vw, 28px);
ย font-weight: normal;
ย text-align: center;
ย width: 100%;
ย letter-spacing: 2px;
ย margin-top: 10px;
ย margin-bottom: 5px;
ย padding: 0;
}

/* ================= SPLASH SCREEN ================= */
#splashScreen {
ย align-items: center;
ย justify-content: center;
ย background-color: var(--bg-dark);
}
.splash-content {
ย text-align: center;
ย display: flex;
ย flex-direction: column;
ย align-items: center;
ย gap: 15px;
}
.splash-logo-container {
ย border-radius: 25px;
ย margin: 20px 0;
ย padding: 15px;
ย /* Efecto Glassmorphism */
ย background: rgba(255, 255, 255, 0.1);
ย backdrop-filter: blur(8px);
ย -webkit-backdrop-filter: blur(8px); /* Para Safari */
ย border: 1px solid rgba(255, 255, 255, 0.15);
ย box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
}
.splash-logo {
ย width: 150px;
ย height: auto;
ย display: block;
ย border-radius: 15px;
}
.splash-loading {
ย font-size: 1.2rem;
ย color: var(--text-medium);
ย letter-spacing: 2px;
}
.splash-loading .dot {
ย animation: blink-dot 1.4s infinite;
ย opacity: 0;
}
.splash-loading .dot:nth-child(2) { animation-delay: 0.2s; }
.splash-loading .dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes blink-dot { 0%, 100% { opacity: 0; } 50% { opacity: 1; } }

/* ================= PANTALLA 1: SELECCIรN DE USUARIO ================= */
#pantalla1 {
ย align-items: center;
ย justify-content: center;
ย gap: 24px;
}
#pantalla1 .brand-header { text-align: center; }
#pantalla1 h1 {
ย margin: 0;
ย font-size: clamp(32px, 5vw, 48px);
ย font-weight: 700;
ย color: var(--text-light);
}
.login-columns-container {
ย display: flex;
ย justify-content: center;
ย gap: 20px;
ย width: 100%;
ย max-width: 600px;
ย flex-wrap: wrap;
}
.login-column {
ย display: flex;
ย flex-direction: column;
ย gap: 16px;
ย flex: 1;
ย min-width: 250px;
}
.login-column .usuario-btn { width: 100%; }
.btn-contenedor {
ย display: flex;
ย flex-wrap: wrap;
ย justify-content: center;
ย gap: 16px;
ย max-width: 800px;
}
/* === BOTรN ESTILO GLASS === */
.usuario-btn {
ย background: rgba(59, 130, 246, 0.25); /* Color base con transparencia */
ย backdrop-filter: blur(10px);
ย -webkit-backdrop-filter: blur(10px);
ย color: var(--text-light);
ย border: 1px solid rgba(255, 255, 255, 0.15);
ย padding: 14px 28px;
ย border-radius: var(--border-radius-sm);
ย font-size: 16px;
ย font-weight: 600;
ย cursor: pointer;
ย transition: background .2s ease, transform .2s ease;
ย box-shadow: var(--shadow-md);
}
.usuario-btn:hover {
ย background: rgba(59, 130, 246, 0.4); /* Aumentar opacidad en hover */
ย transform: translateY(-2px);
ย box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
}
.btn-rojo { background: rgba(239, 68, 68, 0.25); }
.btn-rojo:hover { background: rgba(239, 68, 68, 0.4); }

/* ================= PANTALLA 2: PANEL PRINCIPAL ================= */
#pantalla2 { gap: 10px; }
.header {
ย position: relative;
ย display: flex;
ย align-items: center;
ย justify-content: center;
ย padding: 0 10px;
ย width: 100%;
ย flex-wrap: wrap;
}
#tituloFijo {
ย font-weight: 700;
ย text-align: center;
ย font-size: var(--titulo-size);
ย color: var(--text-light);
}
#turnoActual {
ย position: absolute;
ย right: 10px;
ย top: 50%;
ย transform: translateY(-50%);
ย font-size: 1rem;
ย font-weight: 600;
ย padding: 8px 16px;
ย border-radius: var(--border-radius-sm);
ย /* Efecto Glass */
ย background: rgba(31, 41, 55, 0.5);
ย backdrop-filter: blur(12px);
ย -webkit-backdrop-filter: blur(12px);
ย border: 1px solid rgba(255, 255, 255, 0.1);
}
.zona-centro {
ย flex: 1;
ย display: flex;
ย flex-direction: column;
ย align-items: center;
ย width: 100%;
ย gap: 24px;
ย margin-top: 20px;
}
/* === CARD ESTILO GLASS === */
.resumen-turno {
ย display: flex;
ย justify-content: center;
ย gap: 40px;
ย padding: 20px 40px;
ย width: 100%;
ย max-width: 700px;
ย border-radius: var(--border-radius-md);
ย /* Efecto Glass */
ย background: rgba(31, 41, 55, 0.5);
ย backdrop-filter: blur(12px);
ย -webkit-backdrop-filter: blur(12px);
ย border: 1px solid rgba(255, 255, 255, 0.1);
}
.resumen-turno.oculto { display: none; }
.dato-resumen { text-align: center; }
.dato-resumen .etiqueta {
ย font-size: 14px;
ย color: var(--text-medium);
ย text-transform: uppercase;
ย margin-bottom: 8px;
ย font-weight: 600;
}
.dato-resumen .valor {
ย font-size: 32px;
ย font-weight: 700;
ย color: var(--text-light);
}
.grupo-contenedor {
ย display: flex;
ย flex-wrap: wrap;
ย gap: 24px;
ย width: 100%;
ย max-width: 1400px;
ย justify-content: center;
}
/* === MEJORA: CARD CON FONDO DE PANEL LED === */
.grupo {
ย display: flex;
ย flex-direction: column;
ย align-items: center;
ย text-align: center;
ย padding: 24px;
ย flex-grow: 1;
ย min-width: 300px;
ย transition: transform 0.2s ease, box-shadow 0.2s ease;
ย border-radius: var(--border-radius-md);
ยย
ย /* Nuevo fondo de panel de LEDs apagados */
ย background-color: #18181a; /* Color base oscuro del panel */
ย background-image: radial-gradient(circle at center, rgba(0,0,0,0.4) 2px, transparent 3px);
ย background-size: 12px 12px; /* Controla el tamaรฑo y espaciado de los "puntos" */
ยย
ย border: 1px solid rgba(255, 255, 255, 0.1); /* Mantenemos el borde glass */
ย box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.6); /* Sombra interior para dar relieve */
}
.grupo:hover {
ย transform: translateY(-5px);
ย box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.6), 0 0 20px rgba(59, 130, 246, 0.1);
}
.grupo.oculto { display: none; }
.grupo .nombre {
ย font-size: clamp(20px, 2.2vw, 26px);
ย font-weight: 700;
ย margin-bottom: 8px;
}
.grupo .tarimas {
ย font-size: clamp(16px, 1.7vw, 18px);
ย color: var(--text-medium);
ย margin-bottom: 20px;
}
.leds {
ย display: flex;
ย gap: var(--led-gap);
ย justify-content: center;
ย align-items: center;
ย margin-bottom: 10px;
}
/* === MEJORA LED === */
.led {
ย width: var(--led-size);
ย height: var(--led-size);
ย border-radius: 50%;
ย cursor: pointer;
ย background: radial-gradient(circle at 45% 40%, var(--led-off-core) 40%, var(--led-off-edge) 100%);
ย border: 2px solid var(--led-off-edge);
ย transition: all .2s ease;
ย /* Flexbox para centrar el texto del contador */
ย display: flex;
ย flex-direction: column;
ย justify-content: center;
ย align-items: center;
ย color: var(--text-dark);
ย line-height: 1;
}
.led:active { transform: scale(.96); }
.led.on {
ย background: radial-gradient(circle at 48% 45%, #6EE7B7 40%, var(--accent-green) 100%);
ย box-shadow: 0 0 22px var(--glow-green);
ย border-color: var(--accent-green);
ย animation: blink var(--blink-duration) ease-in-out infinite;
}
/* Estilos para el texto del contador */
.led .tiempo-transcurrido b {
ย ย font-size: 18px;
ย ย font-weight: 700;
}
.led .tiempo-transcurrido small {
ย ย font-size: 10px;
ย ย font-weight: 600;
ย ย text-transform: uppercase;
}
.led.naranja {
ย background: radial-gradient(circle at 48% 45%, #FBBF24 40%, var(--accent-orange) 100%);
ย box-shadow: 0 0 22px var(--glow-orange);
ย border-color: var(--accent-orange);
}
.led.rojo {
ย background: radial-gradient(circle at 48% 45%, #F87171 40%, var(--accent-red) 100%);
ย box-shadow: 0 0 22px var(--glow-red);
ย border-color: var(--accent-red);
}
.led.verde {
ย background: radial-gradient(circle at 48% 45%, #6EE7B7 40%, var(--accent-green) 100%);
ย box-shadow: 0 0 22px var(--glow-green);
ย border-color: var(--accent-green);
}
.led.disabled { cursor: not-allowed; opacity: 0.6; }

.tiempos {
ย margin-top: 10px;
ย font-size: 14px;
ย color: var(--text-medium);
ย text-align: left;
ย width: 100%;
ย max-height: 150px;
ย overflow-y: auto;
ย background-color: rgba(0, 0, 0, 0.2); /* Fondo sutilmente transparente */
ย padding: 10px;
ย border-radius: var(--border-radius-sm);
ย border-top: 1px solid rgba(255,255,255,0.1);
}
.tiempos p { margin: 0 0 5px; }
.contadores-calidad {
ย display: flex;
ย gap: 30px;
ย margin-top: 10px;
}
.contador-calidad {
ย text-align: center;
ย font-weight: 600;
}
.contador-calidad .valor { font-size: 24px; font-weight: 700; }
.contador-calidad .etiqueta { font-size: 12px; color: var(--text-medium); }
.footer { width: 100%; display: flex; justify-content: center; padding: 20px 0 0; }
.footer .usuario-btn { padding: 10px 20px; font-size: 16px; }

@keyframes blink { 50% { box-shadow: 0 0 35px var(--glow-green); } }

/* ================= MODALES ESTILO GLASS ================= */
.modal {
ย position: fixed;
ย top: 0;
ย left: 0;
ย width: 100%;
ย height: 100%;
ย background-color: rgba(0, 0, 0, 0.5); /* Fondo del overlay */
ย backdrop-filter: blur(5px);
ย -webkit-backdrop-filter: blur(5px);
ย display: flex;
ย justify-content: center;
ย align-items: center;
ย z-index: 1000;
ย visibility: hidden;
ย opacity: 0;
ย transition: opacity 0.3s ease, visibility 0.3s ease;
}
.modal.visible { visibility: visible; opacity: 1; }
/* === MODAL ESTILO GLASS === */
.modal-content {
ย padding: 30px;
ย text-align: center;
ย width: 90%;
ย max-width: 500px;
ย box-shadow: var(--shadow-lg);
ย border-radius: var(--border-radius-md);
ย /* Efecto Glass */
ย background: rgba(31, 41, 55, 0.7); /* Mayor opacidad para legibilidad */
ย backdrop-filter: blur(15px);
ย -webkit-backdrop-filter: blur(15px);
ย border: 1px solid rgba(255, 255, 255, 0.15);
}
.modal-content h3 {
ย margin-top: 0;
ย font-size: 22px;
ย margin-bottom: 25px;
}

/* Modal Calidad */
.opciones {
ย display: flex;
ย flex-direction: column;
ย gap: 15px;
ย margin-bottom: 25px;
}
.opcion-btn {
ย padding: 15px 25px;
ย font-size: 18px;
ย font-weight: 600;
ย border: 1px solid rgba(255, 255, 255, 0.15);
ย border-radius: var(--border-radius-sm);
ย cursor: pointer;
ย transition: background 0.2s ease, transform 0.2s ease;
ย color: #fff;
ย backdrop-filter: blur(10px);
ย -webkit-backdrop-filter: blur(10px);
}
.opcion-btn:hover { transform: scale(1.02); }
.opcion-btn[data-color="naranja"] { background: rgba(245, 158, 11, 0.3); }
.opcion-btn[data-color="naranja"]:hover { background: rgba(245, 158, 11, 0.5); }
.opcion-btn[data-color="rojo"] { background: rgba(239, 68, 68, 0.3); }
.opcion-btn[data-color="rojo"]:hover { background: rgba(239, 68, 68, 0.5); }
.opcion-btn[data-color="verde"] { background: rgba(16, 185, 129, 0.3); }
.opcion-btn[data-color="verde"]:hover { background: rgba(16, 185, 129, 0.5); }

.cerrar-btn {
ย background: rgba(55, 65, 81, 0.4); /* --bg-light con transparencia */
ย color: var(--text-light);
ย border: 1px solid rgba(255, 255, 255, 0.1);
ย padding: 10px 20px;
ย border-radius: var(--border-radius-sm);
ย cursor: pointer;
ย font-weight: 600;
ย backdrop-filter: blur(5px);
}
.cerrar-btn:hover { background: rgba(75, 85, 99, 0.6); }

/* Modal de Rechazo */
#modalRechazo .modal-content {
ย text-align: left;
ย max-height: 85vh;ย
ย overflow-y: auto;
}
#modalRechazo form { display: flex; flex-direction: column; gap: 15px; }
#modalRechazo label { font-size: 14px; margin-bottom: 5px; display: block; color: var(--text-medium); }
/* === INPUTS ESTILO GLASS === */
#modalRechazo input, #modalRechazo textarea, .modal-prompt-input {
ย width: 100%;
ย padding: 12px;
ย border-radius: var(--border-radius-sm);
ย color: var(--text-light);
ย font-size: 16px;
ย font-family: var(--font-family);
ย /* Efecto Glass */
ย background: rgba(17, 24, 39, 0.5); /* --bg-dark con transparencia */
ย border: 1px solid rgba(255, 255, 255, 0.1);
}
#modalRechazo input:focus, #modalRechazo textarea:focus, .modal-prompt-input:focus {
ย ย outline: none;
ย ย border-color: var(--accent-blue);
ย ย box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
}
#modalRechazo textarea { resize: vertical; min-height: 80px; }

/* ---- MODALES GENรRICOS ---- */
.modal-generic-message {
ย font-size: 16px;
ย color: var(--text-medium);
ย margin-bottom: 25px;
ย line-height: 1.6;
}
.modal-buttons {
ย display: flex;
ย justify-content: flex-end;
ย gap: 15px;
ย margin-top: 20px;
}

/* ================= PANTALLA 3: REPORTES (TEMA CLARO) ================= */
#pantalla3 {
ย background-color: #f4f7f9;
ย /* Fondo degradado suave para tema claro */
ย background-image:ย
ย ย radial-gradient(at 0% 0%, hsla(210, 40%, 98%, 1) 0, transparent 50%),
ย ย radial-gradient(at 50% 100%, hsla(200, 50%, 90%, 1) 0, transparent 50%);
ย color: var(--text-dark);
ย align-items: center;
ย justify-content: flex-start;
ย gap: 10px;
}
#pantalla3 .zona-centro { margin-top: 0; }
#pantalla3 .brand-title,
#pantalla3 .header h1,
#pantalla3 .header-reporte h2 { color: var(--text-dark); }
/* === CARD ESTILO GLASS (TEMA CLARO) === */
#pantalla3 .contenedor-reporte {
ย box-shadow: var(--shadow-lg);
ย color: var(--text-dark);
ย padding: 20px;
ย width: 100%;
ย max-width: 1400px;
ย margin-top: 20px;
ย border-radius: var(--border-radius-md);
ย /* Efecto Glass */
ย background-color: rgba(255, 255, 255, 0.65);
ย backdrop-filter: blur(12px);
ย -webkit-backdrop-filter: blur(12px);
ย border: 1px solid rgba(255, 255, 255, 0.3);
}
#pantalla3 .header-reporte {
ย display: flex;
ย align-items: center;
ย flex-wrap: wrap;
ย gap: 15px;
ย justify-content: space-between;
ย margin-bottom: 20px;
}
#pantalla3 .header-reporte .filtros {
ย display: flex;
ย flex-wrap: wrap;
ย gap: 10px;
ย align-items: center;
}
#pantalla3 .header-reporte .filtros label { font-size: 14px; color: #64748b; }
#pantalla3 .header-reporte .filtros input,
#pantalla3 .header-reporte .filtros select {
ย padding: 8px;
ย border-radius: var(--border-radius-sm);
ย background-color: rgba(255, 255, 255, 0.5); /* Sutilmente transparente */
ย color: var(--text-dark);
ย border: 1px solid #cbd5e1;
ย font-size: 14px;
}
#pantalla3 .header-reporte .filtros input:focus,
#pantalla3 .header-reporte .filtros select:focus {
ย border-color: var(--accent-blue);
ย box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
ย outline: none;
}
/* Estilo de botones para tema claro */
#pantalla3 .usuario-btn {
ย ย color: var(--text-dark);
ย ย background: rgba(59, 130, 246, 0.15);
ย ย border-color: rgba(59, 130, 246, 0.2);
ย ย backdrop-filter: blur(5px);
ย ย -webkit-backdrop-filter: blur(5px);
}
#pantalla3 .usuario-btn:hover { background: rgba(59, 130, 246, 0.25); }
#pantalla3 .btn-rojo {
ย ย background: rgba(239, 68, 68, 0.15);
ย ย border-color: rgba(239, 68, 68, 0.2);
}
#pantalla3 .btn-rojo:hover { background: rgba(239, 68, 68, 0.25); }

#pantalla3 table {
ย width: 100%;
ย border-collapse: collapse;
ย margin-top: 20px;
ย color: var(--text-dark);
ย display: table;
}
#pantalla3 th, #pantalla3 td {
ย border-bottom: 1px solid #e2e8f0;
ย padding: 12px;
ย text-align: left;
}
#pantalla3 thead {
ย background-color: rgba(241, 245, 249, 0.7); /* Semi-transparente */
ย color: #334155;
ย font-weight: 600;
}
#pantalla3 tbody tr:hover { background-color: rgba(248, 250, 252, 0.8); }
#pantalla3 .resumen-datos {
ย display: flex;
ย flex-wrap: wrap;
ย justify-content: center;
ย gap: 20px;
ย margin-bottom: 20px;
}
#pantalla3 .dato {
ย background-color: rgba(248, 250, 252, 0.7);
ย border: 1px solid #e2e8f0;
ย box-shadow: var(--shadow-md);
ย padding: 15px;
ย border-radius: var(--border-radius-sm);
ย text-align: center;
ย min-width: 150px;
}
#pantalla3 .dato .valor {
ย font-size: 24px;
ย font-weight: 700;
ย color: var(--accent-blue);
}
#pantalla3 .dato .etiqueta {
ย font-size: 12px;
ย text-transform: uppercase;
ย color: #64748b;
}
.grafico-contenedor {
ย width: 100%;
ย max-width: 700px;
ย margin: 30px auto;
}
.reporte-calidad-mobile { display: none; }


/* ================= PANTALLA 4: DASHBOARD ================= */
#pantalla4 {
ย background-color: transparent; /* Usar el fondo del body */
ย color: var(--text-light);
ย padding: 20px;
ย display: grid;
ย grid-template-areas:
ย ย "brand" "header" "filtros" "kpis" "graficos" "pendientes" "footer";
ย gap: 10px;
ย align-content: start;
ย overflow-y: auto;
}
#pantalla4 .brand-title { grid-area: brand; }
#pantalla4 .header { grid-area: header; text-align: center; }
#pantalla4 .filtros-dashboard {
ย grid-area: filtros;
ย display: flex;
ย justify-content: center;
ย gap: 15px;
ย align-items: center;
ย flex-wrap: wrap;
ย margin-top: 20px;
}
#pantalla4 .filtros-dashboard label { font-size: 14px; color: var(--text-medium); }
#pantalla4 .filtros-dashboard input,
#pantalla4 .filtros-dashboard select {
ย padding: 8px;
ย border-radius: var(--border-radius-sm);
ย background-color: rgba(31, 41, 55, 0.5); /* --bg-medium con transparencia */
ย border: 1px solid rgba(255, 255, 255, 0.1);
ย color: var(--text-light);
}
#pantalla4 .kpis-grid {
ย grid-area: kpis;
ย display: grid;
ย grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
ย gap: 20px;
}
/* === CARD ESTILO GLASS === */
#pantalla4 .kpi-card {
ย padding: 25px;
ย text-align: center;
ย transition: transform 0.2s ease, box-shadow 0.2s ease;
ย border-radius: var(--border-radius-md);
ย /* Efecto Glass */
ย background: rgba(31, 41, 55, 0.5);
ย backdrop-filter: blur(12px);
ย -webkit-backdrop-filter: blur(12px);
ย border: 1px solid rgba(255, 255, 255, 0.1);
}
#pantalla4 .kpi-card:hover {
ย ย transform: translateY(-5px);
ย ย box-shadow: 0 0 20px rgba(59, 130, 246, 0.1);
}
#pantalla4 .kpi-card h3 {
ย margin-top: 0;
ย font-size: 1rem;
ย color: var(--text-medium);
ย text-transform: uppercase;
ย font-weight: 600;
}
#pantalla4 .kpi-card .valor {
ย font-size: 3rem;
ย font-weight: 700;
ย color: var(--text-light);
ย transition: color 0.3s ease;
ย margin-top: 10px;
}
#pantalla4 .kpi-card.alerta .valor { color: var(--accent-red); }
#pantalla4 .graficos-container {
ย grid-area: graficos;
ย display: grid;
ย grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
ย gap: 20px;
}
/* === PANEL ESTILO GLASS === */
#pantalla4 .panel {
ย grid-area: pendientes;
ย padding: 20px;
ย border-radius: var(--border-radius-md);
ย /* Efecto Glass */
ย background: rgba(31, 41, 55, 0.5);
ย backdrop-filter: blur(12px);
ย -webkit-backdrop-filter: blur(12px);
ย border: 1px solid rgba(255, 255, 255, 0.1);
}
#pantalla4 .graficos-container .panel { grid-area: unset; }
#pantalla4 .panel h3 {
ย text-align: center;
ย margin-top: 0;
ย margin-bottom: 20px;
ย color: var(--text-light);
}
#pantalla4 #tablaPendientes {
ย width: 100%;
ย border-collapse: collapse;
ย color: var(--text-light);
}
#pantalla4 #tablaPendientes th, #pantalla4 #tablaPendientes td {
ย padding: 12px;
ย border-bottom: 1px solid rgba(55, 65, 81, 0.5); /* --bg-light con transparencia */
ย text-align: left;
}
#pantalla4 #tablaPendientes thead { background-color: rgba(55, 65, 81, 0.4); }
#pantalla4 #tablaPendientes tbody tr:hover { background-color: rgba(75, 85, 99, 0.4); }
#pantalla4 .footer { grid-area: footer; }


/* ================= MEDIA QUERIES RESPONSIVE ================= */
@media (max-width: 768px) {
ย .header { justify-content: center; text-align: center; }
ย #turnoActual { position: static; transform: none; margin-top: 10px; }
ยย
ย #pantalla3 table { display: none; }
ย .reporte-calidad-mobile { display: block; }
ยย
ย #pantalla3 .reporte-calidad-mobile .tabla-calidad-movil .fila-dato {
ย ย background-color: rgba(241, 245, 249, 0.8);
ย ย padding: 10px;
ย ย border-radius: var(--border-radius-sm);
ย ย margin-bottom: 10px;
ย ย color: var(--text-dark);
ย }
ย #pantalla3 .reporte-calidad-mobile .tabla-calidad-movil .etiqueta {
ย ย font-weight: bold;
ย ย color: #64748b;
ย ย display: block;
ย ย font-size: 12px;
ย }
ย #pantalla3 .reporte-calidad-mobile .tabla-calidad-movil .valor {
ย ย color: var(--text-dark);
ย ย font-size: 16px;
ย }
}

@media (min-width: 769px) {
ย .reporte-calidad-mobile { display: none; }
}

@media (min-width: 992px) {
ย #pantalla4 {
ย ย grid-template-columns: 1fr 1fr;
ย ย grid-template-areas:
ย ย ย "brand brand" "header header" "filtros filtros"
ย ย ย "kpis kpis" "graficos graficos" "pendientes pendientes" "footer footer";
ย }
ย #pantalla4 .graficos-container { grid-template-columns: 1fr 1fr; }
ย .graficos-container > *:nth-child(3) { grid-column: span 2; }
}
@media (min-width: 1200px) {
ย #pantalla4 {
ย ย grid-template-columns: repeat(4, 1fr);
ย ย grid-template-areas:
ย ย ย "brand brand brand brand" "header header header header" "filtros filtros filtros filtros"
ย ย ย "kpis kpis kpis kpis" "graficos graficos pendientes pendientes" "footer footer footer footer";
ย }
ย ย#pantalla4 .graficos-container {
ย ย grid-area: graficos;
ย ย grid-template-columns: 1fr;
ย ย grid-template-rows: repeat(3, auto);
ย }
ย .graficos-container > * { grid-column: span 1 !important; }
ย #pantalla4 .panel { grid-area: pendientes; }
}
</style>
</head>
<body>

<section id="splashScreen" class="pantalla activa">
ย ย <div class="splash-content">
ย ย ย ย <p class="brand-title">CORNING</p>
ย ย ย ย <div class="splash-logo-container">
ย ย ย ย ย ย ย<img src="iconolog-512.PNG" alt="Logo de Logรญstica" class="splash-logo">
ย ย ย ย </div>
ย ย ย ย <p class="splash-loading">Cargando<span class="dot">.</span><span class="dot">.</span><span class="dot">.</span></p>
ย ย </div>
</section>

<section id="pantalla1" class="pantalla">
ย ย <div class="brand-header">
ย ย ย ย <p class="brand-title">CORNING</p>
ย ย ย ย <h1 id="mainTitle">Panel de Logรญstica</h1>
ย ย </div>
ย ย <div class="login-columns-container">
ย ย ย ย <div class="login-column">
ย ย ย ย ย ย <button class="usuario-btn" onclick="seleccionarUsuario('LOGรSTICA')">LOGรSTICA</button>
ย ย ย ย ย ย <button class="usuario-btn" onclick="seleccionarUsuario('MULTIPORT')">MULTIPORT</button>
ย ย ย ย ย ย <button class="usuario-btn" onclick="seleccionarUsuario('BEDROCK')">BEDROCK</button>
ย ย ย ย ย ย <button class="usuario-btn" onclick="seleccionarUsuario('DROPS')">DROPS</button>
ย ย ย ย ย ย <button class="usuario-btn" onclick="seleccionarUsuario('CALIDAD')">CALIDAD</button>
ย ย ย ย </div>
ย ย ย ย <div class="login-column">
ย ย ย ย ย ย <button class="usuario-btn" onclick="seleccionarUsuario('SUPERVISOR')">SUPERVISOR</button>
ย ย ย ย ย ย <button class="usuario-btn" onclick="seleccionarDashboard()">DASHBOARD</button>
ย ย ย ย ย ย <button class="usuario-btn" onclick="seleccionarReporte()">REPORTES</button>
ย ย ย ย </div>
ย ย </div>
</section>

<section id="pantalla2" class="pantalla">
ย ย <p class="brand-title">CORNING</p>
ย ย <header class="header">
ย ย ย ย <div id="tituloFijo">LOGรSTICA</div>
ย ย ย ย <div id="turnoActual"></div>
ย ย </header>
ย ย <div class="zona-centro">
ย ย <div id="resumenTurno" class="resumen-turno oculto">
<div class="dato-resumen">
ย ย <div class="etiqueta">Tarimas Totales</div>
ย ย <div id="tarimasTotales" class="valor">0</div>
</div>
<div class="dato-resumen">
ย ย <div class="etiqueta">Tiempo Promedio</div>
ย ย <div id="tiempoPromedio" class="valor">0 min</div>
</div>
</div>
<div class="grupo-contenedor">
ย ย <div class="grupo" data-grupo="MULTIPORT">
ย ย ย ย <div class="nombre">MULTIPORT</div>
ย ย ย ย <div class="tarimas">Tarimas: 0</div>
ย ย ย ย <div class="leds" data-grupo="MULTIPORT" data-linea="linea1"></div>
ย ย ย ย <div class="leds" data-grupo="MULTIPORT" data-linea="linea2"></div>
ย ย ย ย <div class="tiempos" data-grupo="MULTIPORT"></div>
ย ย </div>

ย ย <div class="grupo" data-grupo="DROPS">
ย ย ย ย <div class="nombre">DROPS</div>
ย ย ย ย <div class="tarimas">Tarimas: 0</div>
ย ย ย ย <div class="leds" data-grupo="DROPS" data-linea="linea1"></div>
ย ย ย ย <div class="leds" data-grupo="DROPS" data-linea="linea2"></div>
ย ย ย ย <div class="tiempos" data-grupo="DROPS"></div>
ย ย </div>

ย ย <div class="grupo" data-grupo="BEDROCK">
ย ย ย ย <div class="nombre">BEDROCK</div>
ย ย ย ย <div class="tarimas">Tarimas: 0</div>
ย ย ย ย <div class="leds" data-grupo="BEDROCK" data-linea="linea1"></div>
ย ย ย ย <div class="leds" data-grupo="BEDROCK" data-linea="linea2"></div>
ย ย ย ย <div class="tiempos" data-grupo="BEDROCK"></div>
ย ย </div>

ย ย <div class="grupo" data-grupo="CALIDAD_MULTIPORT">
ย ย ย ย <div class="nombre">CALIDAD MULTIPORT</div>
ย ย ย ย <div class="tarimas">Tarimas: 0</div>
ย ย ย ย <div class="leds" data-grupo="CALIDAD_MULTIPORT" data-linea="linea1"></div>
ย ย ย ย <div class="contadores-calidad">
ย ย ย ย ย ย <div class="contador-calidad">
ย ย ย ย ย ย ย ย <span class="valor" id="liberadas_CALIDAD_MULTIPORT">0</span>
ย ย ย ย ย ย ย ย <div class="etiqueta">Liberadas</div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div class="contador-calidad">
ย ย ย ย ย ย ย ย <span class="valor" id="rechazadas_CALIDAD_MULTIPORT">0</span>
ย ย ย ย ย ย ย ย <div class="etiqueta">Rechazadas</div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย ย ย <div class="tiempos" data-grupo="CALIDAD_MULTIPORT"></div>
ย ย </div>

ย ย <div class="grupo" data-grupo="CALIDAD_DROPS">
ย ย ย ย <div class="nombre">CALIDAD DROPS</div>
ย ย ย ย <div class="tarimas">Tarimas: 0</div>
ย ย ย ย <div class="leds" data-grupo="CALIDAD_DROPS" data-linea="linea1"></div>
ย ย ย ย <div class="contadores-calidad">
ย ย ย ย ย ย <div class="contador-calidad">
ย ย ย ย ย ย ย ย <span class="valor" id="liberadas_CALIDAD_DROPS">0</span>
ย ย ย ย ย ย ย ย <div class="etiqueta">Liberadas</div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div class="contador-calidad">
ย ย ย ย ย ย ย ย <span class="valor" id="rechazadas_CALIDAD_DROPS">0</span>
ย ย ย ย ย ย ย ย <div class="etiqueta">Rechazadas</div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย ย ย <div class="tiempos" data-grupo="CALIDAD_DROPS"></div>
ย ย </div>

ย ย <div class="grupo" data-grupo="CALIDAD_BEDROCK">
ย ย ย ย <div class="nombre">CALIDAD BEDROCK</div>
ย ย ย ย <div class="tarimas">Tarimas: 0</div>
ย ย ย ย <div class="leds" data-grupo="CALIDAD_BEDROCK" data-linea="linea1"></div>
ย ย ย ย <div class="contadores-calidad">
ย ย ย ย ย ย <div class="contador-calidad">
ย ย ย ย ย ย ย ย <span class="valor" id="liberadas_CALIDAD_BEDROCK">0</span>
ย ย ย ย ย ย ย ย <div class="etiqueta">Liberadas</div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div class="contador-calidad">
ย ย ย ย ย ย ย ย <span class="valor" id="rechazadas_CALIDAD_BEDROCK">0</span>
ย ย ย ย ย ย ย ย <div class="etiqueta">Rechazadas</div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย ย ย <div class="tiempos" data-grupo="CALIDAD_BEDROCK"></div>
ย ย </div>
</div>
</div>
<div class="footer">
ย ย <button class="usuario-btn btn-rojo" onclick="volverAPantalla1()">Cerrar sesiรณn</button>
</div>
</section>

<section id="pantalla3" class="pantalla">
ย ย <p class="brand-title">CORNING</p>
ย ย <header class="header">
ย ย ย ย <h1 id="tituloReportes">REPORTES</h1>
ย ย </header>
ย ย <div class="zona-centro">
ย ย ย ย <div id="selectoresReportes" class="btn-contenedor">
ย ย ย ย ย ย <button class="usuario-btn" data-reporte="produccion">PRODUCCIรN</button>
ย ย ย ย ย ย <button class="usuario-btn" data-reporte="logistica">LOGรSTICA</button>
ย ย ย ย ย ย <button class="usuario-btn" data-reporte="calidad">CALIDAD</button>
ย ย ย ย ย ย <button class="usuario-btn" data-reporte="resumen">RESUMEN EJECUTIVO</button>
ย ย ย ย </div>
ย ย ย ย <div id="contenedorReporte" class="contenedor-reporte">
ย ย ย ย ย ย <h2>Selecciona un reporte</h2>
ย ย ย ย </div>
ย ย </div>
ย ย <div class="footer">
ย ย ย ย <button class="usuario-btn btn-rojo" onclick="activarPantalla('pantalla1')">Volver</button>
ย ย </div>
</section>

<section id="pantalla4" class="pantalla" style="display: none;">
ย ย <p class="brand-title">CORNING</p>
ย ย <header class="header">
ย ย ย ย <h1>DASHBOARD DE SUPERVISOR</h1>
ย ย </header>
ย ย <div class="filtros-dashboard">
ย ย ย ย <label for="fechaDashboard">Fecha:</label>
ย ย ย ย <input type="date" id="fechaDashboard">
ย ย ย ย <label for="turnoDashboardSelect">Turno:</label>
ย ย ย ย <select id="turnoDashboardSelect">
ย ย ย ย ย ย <option value="todos">Todos</option>
ย ย ย ย ย ย <option value="Turno 1">Turno 1</option>
ย ย ย ย ย ย <option value="Turno 2">Turno 2</option>
ย ย ย ย </select>
ย ย </div>
ย ย <div class="kpis-grid">
ย ย ย ย <div class="kpi-card">
ย ย ย ย ย ย <h3>Tarimas Confirmadas</h3>
ย ย ย ย ย ย <div class="valor" id="dashTarimasConfirmadas">0</div>
ย ย ย ย </div>
ย ย ย ย <div class="kpi-card">
ย ย ย ย ย ย <h3>Tarimas Recolectadas</h3>
ย ย ย ย ย ย <div class="valor" id="dashTarimasRecolectadas">0</div>
ย ย ย ย </div>
ย ย ย ย <div class="kpi-card" id="kpiTiempoPromedio">
ย ย ย ย ย ย <h3>Tiempo Promedio</h3>
ย ย ย ย ย ย <div class="valor" id="dashTiempoPromedio">0 min</div>
ย ย ย ย </div>
ย ย ย ย <div class="kpi-card" id="kpiTasaRechazo">
ย ย ย ย ย ย <h3>Tasa de Rechazo</h3>
ย ย ย ย ย ย <div class="valor" id="dashTasaRechazo">0%</div>
ย ย ย ย </div>
ย ย </div>
ย ย <div class="graficos-container">
ย ย ย ย <div class="panel">
ย ย ย ย ย ย <h3>Producciรณn por รrea</h3>
ย ย ย ย ย ย <div style="position: relative; height: 300px;"><canvas id="graficoProduccionDash"></canvas></div>
ย ย ย ย </div>
ย ย ย ย <div class="panel">
ย ย ย ย ย ย <h3>Estado de Calidad</h3>
ย ย ย ย ย ย <div style="position: relative; height: 300px;"><canvas id="graficoCalidadDash"></canvas></div>
ย ย ย ย </div>
ย ย ย ย <div class="panel">
ย ย ย ย ย ย <h3>Evoluciรณn Tiempos de Recolecciรณn</h3>
ย ย ย ย ย ย <div style="position: relative; height: 300px;"><canvas id="graficoLogisticaDash"></canvas></div>
ย ย ย ย </div>
ย ย </div>
ย ย <div class="panel">
ย ย ย ย <h3>Tarimas Pendientes por Recolectar</h3>
ย ย ย ย <table id="tablaPendientes">
ย ย ย ย ย ย <thead>
ย ย ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย ย ย <th>รrea</th>
ย ย ย ย ย ย ย ย ย ย <th>Tarimas Pendientes</th>
ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย </thead>
ย ย ย ย ย ย <tbody></tbody>
ย ย ย ย </table>
ย ย </div>
ย ย <div class="footer">
ย ย ย ย <button class="usuario-btn btn-rojo" onclick="activarPantalla('pantalla1')">Volver al inicio</button>
ย ย </div>
</section>

<div id="modalCalidad" class="modal">
<div class="modal-content">
ย ย <h3>Selecciona el estado de la tarima:</h3>
ย ย <div class="opciones">
ย ย ย ย <button class="opcion-btn" data-color="naranja">En proceso ๐ก</button>
ย ย ย ย <button class="opcion-btn" data-color="rojo">Rechazada ๐ด</button>
ย ย ย ย <button class="opcion-btn" data-color="verde">Liberada ๐ข</button>
ย ย </div>
ย ย <button class="cerrar-btn">Cerrar</button>
</div>
</div>
<div id="modalRechazo" class="modal">
<div class="modal-content">
ย ย <h3>Detalles del Rechazo</h3>
ย ย <form id="formularioRechazo">
ย ย ย ย <label for="empleado">Empleado Originador:</label>
ย ย ย ย <input type="text" id="empleado" name="empleado" required>
ย ย ย ย <label for="linea">Lรญnea afectada:</label>
ย ย ย ย <input type="text" id="linea" name="linea" required>
ย ย ย ย <label for="parte">No. de parte:</label>
ย ย ย ย <input type="text" id="parte" name="parte" required>
ย ย ย ย <label for="descripcionParte">Descripciรณn del No. de parte:</label>
ย ย ย ย <input type="text" id="descripcionParte" name="descripcionParte" required>
ย ย ย ย <label for="problema">Descripciรณn del problema:</label>
ย ย ย ย <textarea id="problema" name="problema" required></textarea>
ย ย ย ย <label for="causa">Causa raรญz del problema:</label>
ย ย ย ย <textarea id="causa" name="causa" required></textarea>
ย ย ย ย <label for="accion">Acciรณn correctiva:</label>
ย ย ย ย <textarea id="accion" name="accion" required></textarea>
ย ย ย ย <div class="modal-buttons">
ย ย ย ย ย ย <button type="button" id="cancelRechazo" class="usuario-btn btn-rojo">Cancelar</button>
ย ย ย ย ย ย <button type="submit" class="usuario-btn">Guardar Rechazo</button>
ย ย ย ย </div>
ย ย </form>
</div>
</div>
<div id="modalAlert" class="modal">
ย ย <div class="modal-content">
ย ย ย ย <h3 id="modalAlertTitle">Notificaciรณn</h3>
ย ย ย ย <p id="modalAlertMessage" class="modal-generic-message"></p>
ย ย ย ย <div class="modal-buttons" style="justify-content: center;">
ย ย ย ย ย ย <button id="modalAlertOk" class="usuario-btn">OK</button>
ย ย ย ย </div>
ย ย </div>
</div>
<div id="modalConfirm" class="modal">
ย ย <div class="modal-content">
ย ย ย ย <h3 id="modalConfirmTitle">Confirmaciรณn</h3>
ย ย ย ย <p id="modalConfirmMessage" class="modal-generic-message"></p>
ย ย ย ย <div class="modal-buttons">
ย ย ย ย ย ย <button id="modalConfirmCancel" class="usuario-btn btn-rojo">Cancelar</button>
ย ย ย ย ย ย <button id="modalConfirmOk" class="usuario-btn">Confirmar</button>
ย ย ย ย </div>
ย ย </div>
</div>
<div id="modalPrompt" class="modal">
ย ย <div class="modal-content">
ย ย ย ย <h3 id="modalPromptTitle">Introducir Datos</h3>
ย ย ย ย <p id="modalPromptMessage" class="modal-generic-message"></p>
ย ย ย ย <input type="password" id="modalPromptInput" class="modal-prompt-input" autocomplete="off" />
ย ย ย ย <div class="modal-buttons">
ย ย ย ย ย ย <button id="modalPromptCancel" class="usuario-btn btn-rojo">Cancelar</button>
ย ย ย ย ย ย <button id="modalPromptOk" class="usuario-btn">Aceptar</button>
ย ย ย ย </div>
ย ย </div>
</div>
<script>
// =================================================================================================
// ================================ INICIO DEL CรDIGO JAVASCRIPT ================================
// =================================================================================================

// ================= CONFIG Y ESTADO =================
const CONFIG = {
ย ย USUARIOS: ['MULTIPORT', 'BEDROCK', 'DROPS', 'LOGรSTICA', 'SUPERVISOR', 'CALIDAD'],
ย ย PRODUCCION_GRUPOS: ['MULTIPORT', 'BEDROCK', 'DROPS'],
ย ย PASSWORDS: {
ย ย ย ย 'LOGรSTICA': 'LOGRAM',
ย ย ย ย 'MULTIPORT': 'MP25',
ย ย ย ย 'BEDROCK': 'BR25',
ย ย ย ย 'DROPS': 'DROP25',
ย ย ย ย 'SUPERVISOR': 'SUP25',
ย ย ย ย 'CALIDAD_MULTIPORT': 'AQLMP',
ย ย ย ย 'CALIDAD_DROPS': 'AQLDP',
ย ย ย ย 'CALIDAD_BEDROCK': 'AQLBR',
ย ย ย ย 'REPORTES': 'REPO25',
ย ย ย ย 'DASHBOARD': 'DASH25'
ย ย },
ย ย LEDS_POR_GRUPO: {
ย ย ย ย 'MULTIPORT': 5,
ย ย ย ย 'BEDROCK': 5,
ย ย ย ย 'DROPS': 5,
ย ย ย ย 'CALIDAD_MULTIPORT': 5,
ย ย ย ย 'CALIDAD_BEDROCK': 5,
ย ย ย ย 'CALIDAD_DROPS': 5
ย ย }
};

let usuarioSeleccionado = null;
let ledActivoParaFormulario = { grupo: null, idx: null, linea: null };
let reporteActual = null;
let datosFiltradosReporte = null;
let miGrafico;
let graficosDashboard = {};
let dashboardUpdateInterval;


// ================= FIREBASE =================
// ***** INICIO DEL BLOQUE ACTUALIZADO *****
const firebaseConfig = {
    apiKey: "AIzaSyDahnSPvBNTYot00JCn5CBjggAYFVGhbjE",
    authDomain: "panel-logistica-simple.firebaseapp.com",
    databaseURL: "https://panel-logistica-simple-default-rtdb.firebaseio.com",
    projectId: "panel-logistica-simple",
    storageBucket: "panel-logistica-simple.appspot.com",
    messagingSenderId: "528779971851",
    appId: "1:528779971851:web:90241469a69be3a5a4e60e"
};
// ***** FIN DEL BLOQUE ACTUALIZADO *****

firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const db = database;ย
const ledRef = database.ref('estadoLEDs');
let historialRef;
let contadoresCalidadRef;
let rechazosDetalladosRef;
let dashboardListeners = [];


// ======================= MODALES PERSONALIZADOS =======================
const customAlert = (message, title = "Notificaciรณn") => {
ย ย return new Promise(resolve => {
ย ย ย ย const modal = document.getElementById('modalAlert');
ย ย ย ย document.getElementById('modalAlertTitle').textContent = title;
ย ย ย ย document.getElementById('modalAlertMessage').textContent = message;
ย ย ย ย modal.classList.add('visible');

ย ย ย ย const okButton = document.getElementById('modalAlertOk');
ย ย ย ยย
ย ย ย ย const closeListener = () => {
ย ย ย ย ย ย modal.classList.remove('visible');
ย ย ย ย ย ย okButton.removeEventListener('click', closeListener);
ย ย ย ย ย ย resolve();
ย ย ย ย };

ย ย ย ย okButton.addEventListener('click', closeListener);
ย ย });
};

const customConfirm = (message, title = "Confirmaciรณn") => {
ย ย return new Promise(resolve => {
ย ย ย ย const modal = document.getElementById('modalConfirm');
ย ย ย ย document.getElementById('modalConfirmTitle').textContent = title;
ย ย ย ย document.getElementById('modalConfirmMessage').textContent = message;
ย ย ย ย modal.classList.add('visible');

ย ย ย ย const okButton = document.getElementById('modalConfirmOk');
ย ย ย ย const cancelButton = document.getElementById('modalConfirmCancel');

ย ย ย ย const resolveListener = (value) => {
ย ย ย ย ย ย modal.classList.remove('visible');
ย ย ย ย ย ย okButton.removeEventListener('click', confirmListener);
ย ย ย ย ย ย cancelButton.removeEventListener('click', cancelListener);
ย ย ย ย ย ย resolve(value);
ย ย ย ย };

ย ย ย ย const confirmListener = () => resolveListener(true);
ย ย ย ย const cancelListener = () => resolveListener(false);

ย ย ย ย okButton.addEventListener('click', confirmListener);
ย ย ย ย cancelButton.addEventListener('click', cancelListener);
ย ย });
};

const customPrompt = (message, title = "Introducir Contraseรฑa") => {
ย ย return new Promise(resolve => {
ย ย ย ย const modal = document.getElementById('modalPrompt');
ย ย ย ย const input = document.getElementById('modalPromptInput');
ย ย ย ย document.getElementById('modalPromptTitle').textContent = title;
ย ย ย ย document.getElementById('modalPromptMessage').textContent = message;
ย ย ย ย input.value = '';
ย ย ย ย modal.classList.add('visible');
ย ย ย ยย
ย ย ย ย setTimeout(() => {
ย ย ย ย ย ย input.focus();
ย ย ย ย }, 50);

ย ย ย ย const okButton = document.getElementById('modalPromptOk');
ย ย ย ย const cancelButton = document.getElementById('modalPromptCancel');

ย ย ย ย const resolveListener = (value) => {
ย ย ย ย ย ย modal.classList.remove('visible');
ย ย ย ย ย ย okButton.removeEventListener('click', okListener);
ย ย ย ย ย ย cancelButton.removeEventListener('click', cancelListener);
ย ย ย ย ย ย input.removeEventListener('keydown', enterListener);
ย ย ย ย ย ย resolve(value);
ย ย ย ย };

ย ย ย ย const okListener = () => resolveListener(input.value);
ย ย ย ย const cancelListener = () => resolveListener(null);
ย ย ย ยย
ย ย ย ย const enterListener = (e) => {
ย ย ย ย ย ย if (e.key === 'Enter') {
ย ย ย ย ย ย ย ย e.preventDefault();
ย ย ย ย ย ย ย ย okListener();
ย ย ย ย ย ย }
ย ย ย ย };

ย ย ย ย okButton.addEventListener('click', okListener);
ย ย ย ย cancelButton.addEventListener('click', cancelListener);
ย ย ย ย input.addEventListener('keydown', enterListener);
ย ย });
};
// ======================================================================

// ================= FUNCIONES DE RENDER =================
function inyectaLEDs(){
ย ย document.querySelectorAll('.grupo').forEach(grupoDiv => {
ย ย ย ย grupoDiv.classList.add('oculto');
ย ย });

ย ย if (usuarioSeleccionado === 'SUPERVISOR') {
ย ย ย ย document.querySelectorAll('.grupo').forEach(grupoDiv => {
ย ย ย ย ย ย grupoDiv.classList.remove('oculto');
ย ย ย ย });
ย ย } else if (usuarioSeleccionado === 'LOGรSTICA') {
ย ย ย ย document.querySelectorAll('.grupo:not([data-grupo*="CALIDAD_"])').forEach(grupoDiv => {
ย ย ย ย ย ย grupoDiv.classList.remove('oculto');
ย ย ย ย });
ย ย } else if (usuarioSeleccionado.startsWith('CALIDAD_')) {
ย ย ย ย document.querySelector(`.grupo[data-grupo="${usuarioSeleccionado}"]`).classList.remove('oculto');
ย ย } else {
ย ย ย ย document.querySelector(`.grupo[data-grupo="${usuarioSeleccionado}"]`).classList.remove('oculto');
ย ย ย ย document.querySelector(`.grupo[data-grupo="CALIDAD_${usuarioSeleccionado}"]`).classList.remove('oculto');
ย ย }

ย ย document.querySelectorAll('.grupo:not(.oculto) .leds').forEach(contenedor => {
ย ย ย ย const grupoLeds = contenedor.dataset.grupo;
ย ย ย ย const linea = contenedor.dataset.linea;
ย ย ย ยย
ย ย ย ย const ledsPorLinea = 5;
ย ย ย ย contenedor.innerHTML = '';
ย ย ย ยย
ย ย ย ย for(let i = 0; i < ledsPorLinea; i++){
ย ย ย ย ย ย const led = document.createElement('div');
ย ย ย ย ย ย led.className = 'led';
ย ย ย ย ย ย led.title = `${grupoLeds} โข ${linea} โข LED ${i+1}`;
ย ย ย ย ย ย led.addEventListener('click', () => togglearLED(grupoLeds, i, linea));
ย ย ย ย ย ย contenedor.appendChild(led);
ย ย ย ย }
ย ย });
}

// === MEJORA: Funciรณn global para actualizar todos los contadores a la vez ===
function actualizarTodosLosContadores() {
ย ย document.querySelectorAll('.led.on').forEach(led => {
ย ย ย ย const horaEncendido = led.dataset.horaEncendido;
ย ย ย ย if (horaEncendido) {
ย ย ย ย ย ย const tiempoTranscurridoMs = new Date() - new Date(horaEncendido);
ย ย ย ย ย ย const minutosTranscurridos = Math.floor(tiempoTranscurridoMs / (1000 * 60));
ย ย ย ย ย ยย
ย ย ย ย ย ย let spanTiempo = led.querySelector('.tiempo-transcurrido');
ย ย ย ย ย ย if (!spanTiempo) {
ย ย ย ย ย ย ย ย spanTiempo = document.createElement('span');
ย ย ย ย ย ย ย ย spanTiempo.className = 'tiempo-transcurrido';
ย ย ย ย ย ย ย ย led.appendChild(spanTiempo);
ย ย ย ย ย ย }
ย ย ย ย ย ยย
ย ย ย ย ย ย // Formato de dos lรญneas
ย ย ย ย ย ย spanTiempo.innerHTML = `<b>${minutosTranscurridos}</b><small>min</small>`;
ย ย ย ย }
ย ย });
}


function pintarEstado() {
ย ย db.ref('estadoLEDs').on('value', snapshot => {
ย ย ย ย const estados = snapshot.val() || {};
ย ย ย ย document.querySelectorAll('.leds').forEach(contenedor => {
ย ย ย ย ย ย const grupoLeds = contenedor.dataset.grupo;
ย ย ย ย ย ย const linea = contenedor.dataset.linea;

ย ย ย ย ย ย if (estados[grupoLeds] && estados[grupoLeds][linea]) {
ย ย ย ย ย ย ย ย const ledsEstado = estados[grupoLeds][linea];
ย ย ย ย ย ย ย ย contenedor.querySelectorAll('.led').forEach((led, index) => {
ย ย ย ย ย ย ย ย ย ย led.classList.remove('on', 'naranja', 'rojo', 'verde', 'disabled');
ย ย ย ย ย ย ย ย ย ย led.removeAttribute('data-hora-encendido'); // Limpiar el atributo
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย if (ledsEstado[index]) {
ย ย ย ย ย ย ย ย ย ย ย ย if (grupoLeds.startsWith('CALIDAD_') && ledsEstado[index].color) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย led.classList.add(ledsEstado[index].color);
ย ย ย ย ย ย ย ย ย ย ย ย ย ย led.innerHTML = '';
ย ย ย ย ย ย ย ย ย ย ย ย } else if (ledsEstado[index].encendido) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย led.classList.add('on');
ย ย ย ย ย ย ย ย ย ย ย ย ย ย const horaInicio = ledsEstado[index].horaEncendido || ledsEstado[index].timestamp;
ย ย ย ย ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย // === MEJORA: Guardamos la hora de inicio en el elemento para el actualizador global ===
ย ย ย ย ย ย ย ย ย ย ย ย ย ย led.dataset.horaEncendido = horaInicio;

ย ย ย ย ย ย ย ย ย ย ย ย ย ย let spanTiempo = led.querySelector('.tiempo-transcurrido');
ย ย ย ย ย ย ย ย ย ย ย ย ย ย if (!spanTiempo) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย spanTiempo = document.createElement('span');
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย spanTiempo.className = 'tiempo-transcurrido';
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย led.appendChild(spanTiempo);
ย ย ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย const tiempoTranscurridoMs = new Date() - new Date(horaInicio);
ย ย ย ย ย ย ย ย ย ย ย ย ย ย const minutosTranscurridos = Math.floor(tiempoTranscurridoMs / (1000 * 60));
ย ย ย ย ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย // === MEJORA: Formato de dos lรญneas para la carga inicial ===
ย ย ย ย ย ย ย ย ย ย ย ย ย ย spanTiempo.innerHTML = `<b>${minutosTranscurridos}</b><small>min</small>`;
ย ย ย ย ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย led.innerHTML = '';
ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย ย ย led.innerHTML = '';
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย contenedor.querySelectorAll('.led').forEach(led => {
ย ย ย ย ย ย ย ย ย ย led.classList.remove('on', 'naranja', 'rojo', 'verde', 'disabled');
ย ย ย ย ย ย ย ย ย ย led.removeAttribute('data-hora-encendido');
ย ย ย ย ย ย ย ย ย ย led.innerHTML = '';
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย }
ย ย ย ย });
ย ย });
}
ย
function formatoHora(isoString) {
ย ย if (!isoString) return 'N/A';
ย ย const date = new Date(isoString);
ย ย const hours = String(date.getHours()).padStart(2, '0');
ย ย const minutes = String(date.getMinutes()).padStart(2, '0');
ย ย return `${hours}:${minutes}`;
}

function obtenerTurnoActual() {
ย ย const ahora = new Date();
ย ย const hora = ahora.getHours();
ย ย const minutos = ahora.getMinutes();
ย ย let fecha = new Date(ahora);
ย ย let turno;
ย ย if ((hora > 6 || (hora === 6 && minutos >= 30)) && (hora < 18 || (hora === 18 && minutos < 30))) {
ย ย ย ย turno = 'Turno 1';
ย ย }ย
ย ย else {
ย ย ย ย turno = 'Turno 2';
ย ย ย ย if (hora < 6 || (hora === 6 && minutos < 30)) {
ย ย ย ย ย ย fecha.setDate(ahora.getDate() - 1);
ย ย ย ย }
ย ย }
ย ย const year = fecha.getFullYear();
ย ย const month = String(fecha.getMonth() + 1).padStart(2, '0');
ย ย const day = String(fecha.getDate()).padStart(2, '0');
ย ย const fechaFormateada = `${year}-${month}-${day}`;
ย ย return { fecha: fechaFormateada, turno };
}


function iniciarListenersFirebase() {
ย ย const { fecha, turno } = obtenerTurnoActual();
ย ย document.getElementById('turnoActual').textContent = `Turno actual: ${turno}`;

ย ย if (historialRef) historialRef.off();
ย ย if (contadoresCalidadRef) contadoresCalidadRef.off();
ย ย if (rechazosDetalladosRef) rechazosDetalladosRef.off();
ย ย
ย ย historialRef = database.ref(`historialLogs/${fecha}/${turno}`);
ย ย contadoresCalidadRef = database.ref(`contadoresCalidad/${fecha}/${turno}`);
ย ย rechazosDetalladosRef = database.ref(`rechazosDetallados/${fecha}/${turno}`);

ย ย historialRef.on('value', (snapshot) => {
ย ย ย ย const logs = snapshot.val() || {};
ย ย ย ย const contadores = { MULTIPORT: 0, BEDROCK: 0, DROPS: 0, CALIDAD_MULTIPORT: 0, CALIDAD_BEDROCK: 0, CALIDAD_DROPS: 0 };
ย ย ย ย const tiempos = { MULTIPORT: [], BEDROCK: [], DROPS: [] };
ย ย ย ย let tarimasTotales = 0;
ย ย ย ย let tiempoTotalRecoleccion = 0;

ย ย ย ย if (logs) {
ย ย ย ย ย ย Object.values(logs).forEach(log => {
ย ย ย ย ย ย ย ย if (log.accion === 'encendido' && contadores.hasOwnProperty(log.grupo)) {
ย ย ย ย ย ย ย ย ย ย contadores[log.grupo]++;
ย ย ย ย ย ย ย ย } else if (log.accion === 'apagado' && log.tiempoRecoleccion) {
ย ย ย ย ย ย ย ย ย ย const grupoBase = log.grupo;
ย ย ย ย ย ย ย ย ย ย if(tiempos[grupoBase]) {
ย ย ย ย ย ย ย ย ย ย ย ย tiempos[grupoBase].push(log);
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย tarimasTotales++;
ย ย ย ย ย ย ย ย ย ย tiempoTotalRecoleccion += log.tiempoRecoleccion;
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย });
ย ย ย ย }
ย ย ย ย const tiempoPromedio = tarimasTotales > 0 ? Math.round(tiempoTotalRecoleccion / tarimasTotales) : 0;
ย ย ย ย document.getElementById('tarimasTotales').textContent = tarimasTotales;
ย ย ย ย document.getElementById('tiempoPromedio').textContent = `${tiempoPromedio} min`;
ย ย ย ย const resumenTurnoDiv = document.getElementById('resumenTurno');
ย ย ย ย if (usuarioSeleccionado === 'LOGรSTICA' || usuarioSeleccionado === 'SUPERVISOR') {
ย ย ย ย ย ย resumenTurnoDiv.classList.remove('oculto');
ย ย ย ย } else {
ย ย ย ย ย ย resumenTurnoDiv.classList.add('oculto');
ย ย ย ย }ย ย

ย ย ย ย document.querySelector('.grupo[data-grupo="MULTIPORT"] .tarimas').textContent = `Tarimas: ${contadores.MULTIPORT}`;
ย ย ย ย document.querySelector('.grupo[data-grupo="BEDROCK"] .tarimas').textContent = `Tarimas: ${contadores.BEDROCK}`;
ย ย ย ย document.querySelector('.grupo[data-grupo="DROPS"] .tarimas').textContent = `Tarimas: ${contadores.DROPS}`;
ย ย ย ย document.querySelector('.grupo[data-grupo="CALIDAD_MULTIPORT"] .tarimas').textContent = `Tarimas: ${contadores.CALIDAD_MULTIPORT}`;
ย ย ย ย document.querySelector('.grupo[data-grupo="CALIDAD_BEDROCK"] .tarimas').textContent = `Tarimas: ${contadores.CALIDAD_BEDROCK}`;
ย ย ย ย document.querySelector('.grupo[data-grupo="CALIDAD_DROPS"] .tarimas').textContent = `Tarimas: ${contadores.CALIDAD_DROPS}`;

ย ย ย ย Object.keys(tiempos).forEach(grupo => {
ย ย ย ย ย ย const contenedorTiempos = document.querySelector(`.tiempos[data-grupo="${grupo}"]`);
ย ย ย ย ย ย if (!contenedorTiempos) return;
ย ย ย ย ย ย contenedorTiempos.innerHTML = '';
ย ย ย ย ย ย tiempos[grupo].forEach((logEntry, index) => {
ย ย ย ย ย ย ย ย const p = document.createElement('p');
ย ย ย ย ย ย ย ย const horaInicio = formatoHora(logEntry.horaEncendido);
ย ย ย ย ย ย ย ย const horaFin = formatoHora(logEntry.horaApagado);
ย ย ย ย ย ย ย ย p.textContent = `Tarima ${index + 1}: ${logEntry.tiempoRecoleccion} minutos (${horaInicio} - ${horaFin})`;
ย ย ย ย ย ย ย ย contenedorTiempos.appendChild(p);
ย ย ย ย ย ย });
ย ย ย ย ย ย contenedorTiempos.scrollTop = contenedorTiempos.scrollHeight;
ย ย ย ย });
ย ย });
ย ย contadoresCalidadRef.on('value', (snapshot) => {
ย ย ย ย const contadores = snapshot.val() || {};
ย ย ย ย const gruposCalidad = ['CALIDAD_MULTIPORT', 'CALIDAD_DROPS', 'CALIDAD_BEDROCK'];
ย ย ย ย gruposCalidad.forEach(grupo => {
ย ย ย ย ย ย const liberadas = contadores[grupo] ? contadores[grupo].liberadas || 0 : 0;
ย ย ย ย ย ย const rechazadas = contadores[grupo] ? contadores[grupo].rechazadas || 0 : 0;ย ย ย ยย
ย ย ย ย ย ย const liberadasSpan = document.getElementById(`liberadas_${grupo}`);
ย ย ย ย ย ย const rechazadasSpan = document.getElementById(`rechazadas_${grupo}`);
ย ย ย ย ย ย if (liberadasSpan) liberadasSpan.textContent = liberadas;
ย ย ย ย ย ย if (rechazadasSpan) rechazadasSpan.textContent = rechazadas;
ย ย ย ย });
ย ย });
}
// ================= PERMISOS Y LรGICA =================
function esUsuarioProduccion() {
ย ย return CONFIG.PRODUCCION_GRUPOS.includes(usuarioSeleccionado);
}

async function togglearLED(grupo, idx, linea = 'linea1') {
ย ย const ledRef = db.ref('estadoLEDs/' + grupo + '/' + linea + '/' + idx);

ย ย if (grupo.startsWith('CALIDAD_')) {
ย ย ย ย ledRef.once('value', async (snapshot) => {
ย ย ย ย ย ย const estadoActual = snapshot.val() || {};
ย ย ย ย ย ย const grupoBaseCalidad = grupo.replace('CALIDAD_', '');

ย ย ย ย ย ย if (usuarioSeleccionado.startsWith('CALIDAD_')) {
ย ย ย ย ย ย ย ย if(estadoActual.color === 'verde') {
ย ย ย ย ย ย ย ย ย ย return customAlert('Este LED ya estรก liberado y no puede ser modificado por Calidad.', 'Acciรณn no permitida');
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย mostrarOpcionesCalidad(grupo, idx, linea);ย
ย ย ย ย ย ย } else if (esUsuarioProduccion() && usuarioSeleccionado === grupoBaseCalidad) {
ย ย ย ย ย ย ย ย if (estadoActual.color === 'verde') {
ย ย ย ย ย ย ย ย ย ย const confirmado = await customConfirm('ยฟEstรก seguro de que la tarima ha sido liberada y retirada?', 'Confirmar Retiro');
ย ย ย ย ย ย ย ย ย ย if (!confirmado) return;

ย ย ย ย ย ย ย ย ย ย ledRef.set(null);
ย ย ย ย ย ย ย ย ย ย const log = {
ย ย ย ย ย ย ย ย ย ย ย ย usuario: usuarioSeleccionado,
ย ย ย ย ย ย ย ย ย ย ย ย grupo: grupo,
ย ย ย ย ย ย ย ย ย ย ย ย led: `${linea}-${idx+1}`,
ย ย ย ย ย ย ย ย ย ย ย ย accion: 'apagado_calidad',
ย ย ย ย ย ย ย ย ย ย ย ย timestamp: new Date().toISOString(),
ย ย ย ย ย ย ย ย ย ย };
ย ย ย ย ย ย ย ย ย ย historialRef.push(log);
ย ย ย ย ย ย ย ย } else if (estadoActual.color === 'rojo' || estadoActual.color === 'naranja') {
ย ย ย ย ย ย ย ย ย ย await customAlert('Solo puedes apagar LEDs liberados (verdes). Contacte a Calidad si es necesario.', 'Acciรณn no permitida');
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย await customAlert('Este LED aรบn no ha sido inspeccionado por Calidad.', 'Estado pendiente');
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย await customAlert('No tienes permiso para controlar estos LEDs.', 'Acceso denegado');
ย ย ย ย ย ย }
ย ย ย ย });
ย ย } else { // Grupos de Producciรณn
ย ย ย ย ledRef.once('value', async (snapshot) => {
ย ย ย ย ย ย const estadoActual = snapshot.val() || {};
ย ย ย ย ย ยย
ย ย ย ย ย ย if (usuarioSeleccionado === 'LOGรSTICA') {
ย ย ย ย ย ย ย ย if (estadoActual.encendido) {
ย ย ย ย ย ย ย ย ย ย const confirmado = await customConfirm('ยฟConfirma que la tarima ha sido recolectada?', 'Confirmar Recolecciรณn');
ย ย ย ย ย ย ย ย ย ย if (!confirmado) return;
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย const horaInicio = estadoActual.horaEncendido || estadoActual.timestamp;
ย ย ย ย ย ย ย ย ย ย const tiempoRecoleccion = (new Date() - new Date(horaInicio)) / 60000;

ย ย ย ย ย ย ย ย ย ย ledRef.set({
ย ย ย ย ย ย ย ย ย ย ย ย encendido: false,
ย ย ย ย ย ย ย ย ย ย ย ย horaEncendido: null,
ย ย ย ย ย ย ย ย ย ย ย ย usuario: usuarioSeleccionado,
ย ย ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย const log = {
ย ย ย ย ย ย ย ย ย ย ย ย usuario: usuarioSeleccionado,
ย ย ย ย ย ย ย ย ย ย ย ย grupo: grupo,
ย ย ย ย ย ย ย ย ย ย ย ย led: `${linea}-${idx+1}`,
ย ย ย ย ย ย ย ย ย ย ย ย accion: 'apagado',
ย ย ย ย ย ย ย ย ย ย ย ย timestamp: new Date().toISOString(),
ย ย ย ย ย ย ย ย ย ย ย ย tiempoRecoleccion: Math.round(tiempoRecoleccion),
ย ย ย ย ย ย ย ย ย ย ย ย horaEncendido: horaInicio,
ย ย ย ย ย ย ย ย ย ย ย ย horaApagado: new Date().toISOString()
ย ย ย ย ย ย ย ย ย ย };
ย ย ย ย ย ย ย ย ย ย historialRef.push(log);
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย await customAlert('LOGรSTICA solo puede apagar LEDs que ya han sido encendidos por producciรณn.', 'Acciรณn no permitida');
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย } else if (esUsuarioProduccion()) {
ย ย ย ย ย ย ย ย if (!estadoActual.encendido) {
ย ย ย ย ย ย ย ย ย ย const confirmado = await customConfirm('ยฟConfirma que hay una nueva tarima lista para recolecciรณn?', 'Confirmar Tarima');
ย ย ย ย ย ย ย ย ย ย if (!confirmado) return;

ย ย ย ย ย ย ย ย ย ย ledRef.set({
ย ย ย ย ย ย ย ย ย ย ย ย encendido: true,
ย ย ย ย ย ย ย ย ย ย ย ย timestamp: new Date().toISOString(),
ย ย ย ย ย ย ย ย ย ย ย ย usuario: usuarioSeleccionado,
ย ย ย ย ย ย ย ย ย ย ย ย horaEncendido: new Date().toISOString(), // Usar hora del cliente para consistencia inmediata
ย ย ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย const log = {
ย ย ย ย ย ย ย ย ย ย ย ย usuario: usuarioSeleccionado,
ย ย ย ย ย ย ย ย ย ย ย ย grupo: grupo,
ย ย ย ย ย ย ย ย ย ย ย ย led: `${linea}-${idx+1}`,
ย ย ย ย ย ย ย ย ย ย ย ย accion: 'encendido',
ย ย ย ย ย ย ย ย ย ย ย ย timestamp: new Date().toISOString(),
ย ย ย ย ย ย ย ย ย ย ย ย horaEncendido: new Date().toISOString(),
ย ย ย ย ย ย ย ย ย ย ย ย horaApagado: null
ย ย ย ย ย ย ย ย ย ย };
ย ย ย ย ย ย ย ย ย ย historialRef.push(log);
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย await customAlert('El LED ya estรก encendido. Logรญstica debe recolectar la tarima antes de que pueda encender otra.', 'Tarima Pendiente');
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย await customAlert('No tienes permiso para controlar estos LEDs.', 'Acceso denegado');
ย ย ย ย ย ย }
ย ย ย ย });
ย ย }
}

// ================= LรGICA DE CALIDAD MODAL =================
function mostrarOpcionesCalidad(grupo, idx, linea) {
ย ย ledActivoParaFormulario = { grupo, idx, linea };
ย ย document.getElementById('modalCalidad').classList.add('visible');
}

function aplicarEstadoCalidad(nuevoColor) {
ย ย const { grupo, idx, linea } = ledActivoParaFormulario;
ย ย const ledRef = db.ref(`estadoLEDs/${grupo}/${linea}/${idx}`);

ย ย if (nuevoColor === 'verde') {
ย ย ย ย const contadorRef = contadoresCalidadRef.child(grupo);
ย ย ย ย contadorRef.child('liberadas').transaction(currentCount => (currentCount || 0) + 1);
ย ย ย ย ledRef.update({
ย ย ย ย ย ย color: nuevoColor,
ย ย ย ย ย ย timestamp: new Date().toISOString(),
ย ย ย ย ย ย usuario: usuarioSeleccionado,
ย ย ย ย ย ย disabled: true
ย ย ย ย });
ย ย } else {
ย ย ย ย ledRef.update({
ย ย ย ย ย ย color: nuevoColor,
ย ย ย ย ย ย timestamp: new Date().toISOString(),
ย ย ย ย ย ย usuario: usuarioSeleccionado,
ย ย ย ย ย ย disabled: false
ย ย ย ย });
ย ย ย ย if (nuevoColor === 'rojo') {
ย ย ย ย ย ย const contadorRef = contadoresCalidadRef.child(grupo);
ย ย ย ย ย ย contadorRef.child('rechazadas').transaction(currentCount => (currentCount || 0) + 1);
ย ย ย ย }
ย ย }
}

function mostrarFormularioRechazo() {
ย ย document.getElementById('modalCalidad').classList.remove('visible');
ย ย document.getElementById('modalRechazo').classList.add('visible');
}

function guardarRechazo(datos) {
ย ย const ahora = new Date();
ย ย const fecha = ahora.toLocaleDateString('es-MX');
ย ย const hora = ahora.toLocaleTimeString('es-MX', {hour: '2-digit', minute: '2-digit'});

ย ย const datosCompletos = {
ย ย ย ย ...datos,
ย ย ย ย fecha: fecha,
ย ย ย ย hora: hora,
ย ย ย ย timestamp: ahora.toISOString(),
ย ย ย ย areaRechazo: ledActivoParaFormulario.grupo
ย ย };

ย ย rechazosDetalladosRef.push(datosCompletos)
ย ย ย ย .then(() => {
ย ย ย ย ย ย console.log("Rechazo guardado exitosamente:", datosCompletos);
ย ย ย ย ย ย aplicarEstadoCalidad('rojo');
ย ย ย ย })
ย ย ย ย .catch(async (error) => {
ย ย ย ย ย ย console.error("Error guardando rechazo:", error);
ย ย ย ย ย ย await customAlert("Hubo un error al guardar el rechazo.", "Error");
ย ย ย ย })
ย ย ย ย .finally(() => {
ย ย ย ย ย ย document.getElementById('modalRechazo').classList.remove('visible');
ย ย ย ย });
}

// ================= NAVEGACIรN Y ARRANQUE =================
function activarPantalla(id){
ย ย document.querySelectorAll('.pantalla').forEach(p => {
ย ย ย ย p.style.display = 'none';
ย ย ย ย p.classList.remove('activa');
ย ย });
ย ย const pantalla = document.getElementById(id);
ย ย pantalla.style.display = 'flex';
ย ย pantalla.classList.add('activa');
}

function volverAPantalla1(){
ย ย usuarioSeleccionado = null;
ย ย db.ref('estadoLEDs').off();ย
ย ย if (historialRef) historialRef.off();
ย ย if (contadoresCalidadRef) contadoresCalidadRef.off();
ย ย if (rechazosDetalladosRef) rechazosDetalladosRef.off();
ย ย clearInterval(dashboardUpdateInterval);
ย ย activarPantalla('pantalla1');
}

async function seleccionarUsuario(usuario) {
ย ย if (!CONFIG.USUARIOS.includes(usuario)) return;
ย ยย
ย ย let password;
ย ย if (usuario === 'CALIDAD') {
ย ย ย ย password = await customPrompt('Introduce la contraseรฑa para CALIDAD:');
ย ย } else {
ย ย ย ย password = await customPrompt(`Introduce la contraseรฑa para ${usuario}:`);
ย ย }

ย ย if (password === null) return;

ย ย let loginSuccess = false;
ย ย let welcomeMessage = '';
ย ยย
ย ย if (usuario === 'SUPERVISOR' && password === CONFIG.PASSWORDS['SUPERVISOR']) {
ย ย ย ย loginSuccess = true;
ย ย ย ย usuarioSeleccionado = 'SUPERVISOR';
ย ย ย ย document.getElementById('tituloFijo').textContent = 'SUPERVISOR';
ย ย ย ย welcomeMessage = `ยกBienvenido, SUPERVISOR!`;
ย ย } else if (usuario === 'CALIDAD') {
ย ย ย ย let subusuario = null;
ย ย ย ย if (password === CONFIG.PASSWORDS['CALIDAD_MULTIPORT']) subusuario = 'CALIDAD_MULTIPORT';
ย ย ย ย else if (password === CONFIG.PASSWORDS['CALIDAD_DROPS']) subusuario = 'CALIDAD_DROPS';
ย ย ย ย else if (password === CONFIG.PASSWORDS['CALIDAD_BEDROCK']) subusuario = 'CALIDAD_BEDROCK';
ย ย ย ยย
ย ย ย ย if (subusuario) {
ย ย ย ย ย ย loginSuccess = true;
ย ย ย ย ย ย usuarioSeleccionado = subusuario;
ย ย ย ย ย ย document.getElementById('tituloFijo').textContent = `CALIDAD - ${subusuario.split('_')[1]}`;
ย ย ย ย ย ย welcomeMessage = `ยกBienvenido, ${subusuario.replace('_', ' ')}!`;
ย ย ย ย }
ย ย } else {
ย ย ย ย if (password === CONFIG.PASSWORDS[usuario]) {
ย ย ย ย ย ย loginSuccess = true;
ย ย ย ย ย ย usuarioSeleccionado = usuario;
ย ย ย ย ย ย document.getElementById('tituloFijo').textContent = usuario;
ย ย ย ย ย ย welcomeMessage = `ยกBienvenido, ${usuario}!`;
ย ย ย ย }
ย ย }

ย ย if (loginSuccess) {
ย ย ย ย activarPantalla('pantalla2');
ย ย ย ย inyectaLEDs();
ย ย ย ย pintarEstado();
ย ย ย ย iniciarListenersFirebase();
ย ย ย ย await customAlert(welcomeMessage, 'Acceso Concedido');
ย ย } else {
ย ย ย ย await customAlert('Contraseรฑa incorrecta. Intรฉntalo de nuevo.', 'Error de Autenticaciรณn');
ย ย }
}

async function seleccionarReporte() {
ย ย const password = await customPrompt('Introduce la contraseรฑa para REPORTES:');
ย ย if (password === CONFIG.PASSWORDS['REPORTES']) {
ย ย ย ย activarPantalla('pantalla3');
ย ย ย ย document.getElementById('tituloReportes').textContent = 'REPORTES';
ย ย ย ย document.getElementById('selectoresReportes').style.display = 'flex';
ย ย ย ย document.getElementById('contenedorReporte').innerHTML = '<h2>Selecciona un reporte</h2>';
ย ย } else if (password !== null) {
ย ย ย ย await customAlert('Contraseรฑa incorrecta. Acceso denegado.', 'Acceso Denegado');
ย ย }
}

async function seleccionarDashboard() {
ย ย const password = await customPrompt('Introduce la contraseรฑa para DASHBOARD:');
ย ย if (password === CONFIG.PASSWORDS['DASHBOARD']) {
ย ย ย ย activarPantalla('pantalla4');
ย ย ย ย iniciarDashboard();
ย ย } else if (password !== null) {
ย ย ย ย await customAlert('Contraseรฑa incorrecta. Acceso denegado.', 'Acceso Denegado');
ย ย }
}

// ================= FUNCIONES DE DASHBOARD =================
function limpiarDashboardListeners() {
ย ย dashboardListeners.forEach(listener => listener.off());
ย ย dashboardListeners = [];
}

function iniciarDashboard() {
ย ย limpiarDashboardListeners();
ย ย const { fecha, turno } = obtenerTurnoActual();
ย ย document.getElementById('fechaDashboard').value = fecha;
ย ย document.getElementById('turnoDashboardSelect').value = 'todos';
ย ยย
ย ย setupDashboardListeners(fecha, turno);
ย ยย
ย ย document.getElementById('fechaDashboard').addEventListener('change', () => {
ย ย ย ย setupDashboardListeners(document.getElementById('fechaDashboard').value, document.getElementById('turnoDashboardSelect').value);
ย ย });

ย ย document.getElementById('turnoDashboardSelect').addEventListener('change', () => {
ย ย ย ย setupDashboardListeners(document.getElementById('fechaDashboard').value, document.getElementById('turnoDashboardSelect').value);
ย ย });
}

function setupDashboardListeners(fecha, turno) {
ย ย limpiarDashboardListeners();
ย ยย
ย ย const historialRefDash = db.ref(`historialLogs/${fecha}`);
ย ย const calidadRefDash = db.ref(`contadoresCalidad/${fecha}`);
ย ย const ledsRefDash = db.ref('estadoLEDs');

ย ย const historialListener = historialRefDash.on('value', snapshot => {
ย ย ย ย const logsPorTurno = snapshot.val() || {};
ย ย ย ย let logsFiltrados = {};
ย ย ย ย if (turno === 'todos') {
ย ย ย ย ย ย Object.values(logsPorTurno).forEach(logs => {
ย ย ย ย ย ย ย ย logsFiltrados = { ...logsFiltrados, ...logs };
ย ย ย ย ย ย });
ย ย ย ย } else {
ย ย ย ย ย ย logsFiltrados = logsPorTurno[turno] || {};
ย ย ย ย }
ย ย ย ย actualizarDashboard(logsFiltrados, 'historial', null, null);
ย ย });
ย ย dashboardListeners.push({ off: () => historialRefDash.off('value', historialListener) });

ย ย const calidadListener = calidadRefDash.on('value', snapshot => {
ย ย ย ย const contadoresPorTurno = snapshot.val() || {};
ย ย ย ย let contadoresFiltrados = {};
ย ย ย ย if (turno === 'todos') {
ย ย ย ย ย ย for (const t in contadoresPorTurno) {
ย ย ย ย ย ย ย ย for (const g in contadoresPorTurno[t]) {
ย ย ย ย ย ย ย ย ย ย contadoresFiltrados[g] = contadoresFiltrados[g] || { liberadas: 0, rechazadas: 0 };
ย ย ย ย ย ย ย ย ย ย contadoresFiltrados[g].liberadas += contadoresPorTurno[t][g].liberadas || 0;
ย ย ย ย ย ย ย ย ย ย contadoresFiltrados[g].rechazadas += contadoresPorTurno[t][g].rechazadas || 0;
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย } else {
ย ย ย ย ย ย contadoresFiltrados = contadoresPorTurno[turno] || {};
ย ย ย ย }
ย ย ย ย actualizarDashboard(null, 'calidad', contadoresFiltrados, null);
ย ย });
ย ย dashboardListeners.push({ off: () => calidadRefDash.off('value', calidadListener) });
ย ยย
ย ย const ledsListener = ledsRefDash.on('value', snapshot => {
ย ย ย ย const leds = snapshot.val() || {};
ย ย ย ย actualizarDashboard(null, 'leds', null, leds);
ย ย });
ย ย dashboardListeners.push({ off: () => ledsRefDash.off('value', ledsListener) });
}


function actualizarDashboard(historialLogs, tipo, contadoresCalidad, estadoLEDs, filtroArea = 'TODAS') {
ย ย if (tipo === 'historial') {
ย ย ย ย const produccionPorArea = { MULTIPORT: 0, DROPS: 0, BEDROCK: 0 };
ย ย ย ย const tarimasPorHora = {};
ย ย ย ย let tarimasRecolectadas = 0;
ย ย ย ย let tiempoTotalRecoleccion = 0;
ย ย ย ยย
ย ย ย ย for (const logKey in historialLogs) {
ย ย ย ย ย ย const log = historialLogs[logKey];
ย ย ย ย ย ยย
ย ย ย ย ย ย if (filtroArea === 'TODAS' || log.grupo === filtroArea) {
ย ย ย ย ย ย ย ย if (log.accion === 'encendido' && produccionPorArea.hasOwnProperty(log.grupo)) {
ย ย ย ย ย ย ย ย ย ย produccionPorArea[log.grupo]++;
ย ย ย ย ย ย ย ย } else if (log.accion === 'apagado' && log.tiempoRecoleccion && ['MULTIPORT', 'BEDROCK', 'DROPS'].includes(log.grupo)) {
ย ย ย ย ย ย ย ย ย ย tarimasRecolectadas++;
ย ย ย ย ย ย ย ย ย ย tiempoTotalRecoleccion += log.tiempoRecoleccion;
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย const horaApagado = new Date(log.horaApagado);
ย ย ย ย ย ย ย ย ย ย const horaRedondeada = horaApagado.getHours();
ย ย ย ย ย ย ย ย ย ย tarimasPorHora[horaRedondeada] = (tarimasPorHora[horaRedondeada] || 0) + 1;
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย }
ย ย ย ยย
ย ย ย ย const tiempoPromedio = tarimasRecolectadas > 0 ? (tiempoTotalRecoleccion / tarimasRecolectadas).toFixed(1) : 0;
ย ย ย ยย
ย ย ย ย document.getElementById('dashTarimasConfirmadas').textContent = Object.values(produccionPorArea).reduce((a, b) => a + b, 0);
ย ย ย ย document.getElementById('dashTarimasRecolectadas').textContent = tarimasRecolectadas;
ย ย ย ย document.getElementById('dashTiempoPromedio').textContent = `${tiempoPromedio} min`;
ย ย ย ยย
ย ย ย ย const kpiTiempoPromedio = document.getElementById('kpiTiempoPromedio');
ย ย ย ย if (tiempoPromedio > 10) {
ย ย ย ย ย ย kpiTiempoPromedio.classList.add('alerta');
ย ย ย ย } else {
ย ย ย ย ย ย kpiTiempoPromedio.classList.remove('alerta');
ย ย ย ย }
ย ย ย ยย
ย ย ย ย generarGraficoProduccionDash(produccionPorArea);
ย ย ย ย generarGraficoLogisticaDash(tarimasPorHora);
ย ย }
ย ยย
ย ย if (tipo === 'calidad') {
ย ย ย ย let liberadas = 0;
ย ย ย ย let rechazadas = 0;
ย ย ย ย for (const grupo in contadoresCalidad) {
ย ย ย ย ย ย liberadas += contadoresCalidad[grupo].liberadas || 0;
ย ย ย ย ย ย rechazadas += contadoresCalidad[grupo].rechazadas || 0;
ย ย ย ย }
ย ย ย ย const totalCalidad = liberadas + rechazadas;
ย ย ย ย const tasaRechazo = totalCalidad > 0 ? ((rechazadas / totalCalidad) * 100).toFixed(1) : 0;
ย ย ย ยย
ย ย ย ย document.getElementById('dashTasaRechazo').textContent = `${tasaRechazo}%`;

ย ย ย ย const kpiTasaRechazo = document.getElementById('kpiTasaRechazo');
ย ย ย ย if (tasaRechazo > 5) {
ย ย ย ย ย ย kpiTasaRechazo.classList.add('alerta');
ย ย ย ย } else {
ย ย ย ย ย ย kpiTasaRechazo.classList.remove('alerta');
ย ย ย ย }
ย ย ย ย generarGraficoCalidadDash({ liberadas, rechazadas });
ย ย }

ย ย if (tipo === 'leds') {
ย ย ย ย const pendientesPorArea = {};
ย ย ย ยย
ย ย ย ย CONFIG.PRODUCCION_GRUPOS.forEach(grupo => {
ย ย ย ย ย ย pendientesPorArea[grupo] = 0;
ย ย ย ย ย ย if (estadoLEDs.hasOwnProperty(grupo)) {
ย ย ย ย ย ย ย ย for (const linea in estadoLEDs[grupo]) {
ย ย ย ย ย ย ย ย ย ย for (const led in estadoLEDs[grupo][linea]) {
ย ย ย ย ย ย ย ย ย ย ย ย if (estadoLEDs[grupo][linea][led].encendido) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย pendientesPorArea[grupo]++;
ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย });
ย ย ย ยย
ย ย ย ย const tablaPendientesBody = document.querySelector('#tablaPendientes tbody');
ย ย ย ย tablaPendientesBody.innerHTML = '';
ย ย ย ย for (const area in pendientesPorArea) {
ย ย ย ย ย ย const tr = document.createElement('tr');
ย ย ย ย ย ย tr.innerHTML = `<td>${area}</td><td>${pendientesPorArea[area]}</td>`;
ย ย ย ย ย ย tablaPendientesBody.appendChild(tr);
ย ย ย ย }
ย ย }
}
function generarGraficoProduccionDash(datos) {
ย ย if (graficosDashboard.produccion) {
ย ย ย ย graficosDashboard.produccion.destroy();
ย ย }
ย ย const ctx = document.getElementById('graficoProduccionDash').getContext('2d');
ย ย const labels = Object.keys(datos);
ย ย const data = Object.values(datos);
ย ย graficosDashboard.produccion = new Chart(ctx, {
ย ย ย ย type: 'bar',
ย ย ย ย data: {
ย ย ย ย ย ย labels: labels,
ย ย ย ย ย ย datasets: [{
ย ย ย ย ย ย ย ย label: 'Tarimas Confirmadas',
ย ย ย ย ย ย ย ย data: data,
ย ย ย ย ย ย ย ย backgroundColor: ['#4BC0C0', '#36A2EB', '#FFCE56'],
ย ย ย ย ย ย ย ย borderColor: ['#4BC0C0', '#36A2EB', '#FFCE56'],
ย ย ย ย ย ย ย ย borderWidth: 1
ย ย ย ย ย ย }]
ย ย ย ย },
ย ย ย ย options: {
ย ย ย ย ย ย responsive: true, maintainAspectRatio: false,
ย ย ย ย ย ย scales: {
ย ย ย ย ย ย ย ย y: { beginAtZero: true, title: { display: true, text: 'Tarimas' } }
ย ย ย ย ย ย },
ย ย ย ย ย ย plugins: {
ย ย ย ย ย ย ย ย legend: { display: false },
ย ย ย ย ย ย ย ย title: { display: false }
ย ย ย ย ย ย }
ย ย ย ย }
ย ย });
}

function generarGraficoCalidadDash(datos) {
ย ย if (graficosDashboard.calidad) {
ย ย ย ย graficosDashboard.calidad.destroy();
ย ย }
ย ย const ctx = document.getElementById('graficoCalidadDash').getContext('2d');
ย ย const labels = ['Liberadas', 'Rechazadas'];
ย ย const data = [datos.liberadas, datos.rechazadas];
ย ย graficosDashboard.calidad = new Chart(ctx, {
ย ย ย ย type: 'pie',
ย ย ย ย data: {
ย ย ย ย ย ย labels: labels,
ย ย ย ย ย ย datasets: [{
ย ย ย ย ย ย ย ย data: data,
ย ย ย ย ย ย ย ย backgroundColor: ['#4caf50', '#f44336']
ย ย ย ย ย ย }]
ย ย ย ย },
ย ย ย ย options: {
ย ย ย ย ย ย responsive: true, maintainAspectRatio: false,
ย ย ย ย ย ย plugins: {
ย ย ย ย ย ย ย ย legend: { position: 'top' },
ย ย ย ย ย ย ย ย title: { display: false }
ย ย ย ย ย ย }
ย ย ย ย }
ย ย });
}

function generarGraficoLogisticaDash(tarimasPorHora) {
ย ย if (graficosDashboard.logistica) {
ย ย ย ย graficosDashboard.logistica.destroy();
ย ย }
ย ย const ctx = document.getElementById('graficoLogisticaDash').getContext('2d');
ย ยย
ย ย const horasOrdenadas = Object.keys(tarimasPorHora).sort((a, b) => a - b);
ย ย const labels = horasOrdenadas.map(hora => `${hora}:00 - ${parseInt(hora) + 1}:00`);
ย ย const data = horasOrdenadas.map(hora => tarimasPorHora[hora] || 0);

ย ย graficosDashboard.logistica = new Chart(ctx, {
ย ย ย ย type: 'bar',
ย ย ย ย data: {
ย ย ย ย ย ย labels: labels,ย
ย ย ย ย ย ย datasets: [{
ย ย ย ย ย ย ย ย label: 'Tarimas Recolectadas por Hora',
ย ย ย ย ย ย ย ย data: data,
ย ย ย ย ย ย ย ย backgroundColor: '#36A2EB',
ย ย ย ย ย ย ย ย borderColor: '#36A2EB',
ย ย ย ย ย ย ย ย borderWidth: 1
ย ย ย ย ย ย }]
ย ย ย ย },
ย ย ย ย options: {
ย ย ย ย ย ย responsive: true,
ย ย ย ย ย ย maintainAspectRatio: false,
ย ย ย ย ย ย scales: {
ย ย ย ย ย ย ย ย y: {
ย ย ย ย ย ย ย ย ย ย beginAtZero: true,
ย ย ย ย ย ย ย ย ย ย title: { display: true, text: 'Tarimas Recolectadas' },
ย ย ย ย ย ย ย ย ย ย ticks: { stepSize: 1 }
ย ย ย ย ย ย ย ย },
ย ย ย ย ย ย ย ย x: {
ย ย ย ย ย ย ย ย ย ย title: { display: true, text: 'Hora del Dรญa' }
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย },
ย ย ย ย ย ย plugins: {
ย ย ย ย ย ย ย ย legend: { display: false }
ย ย ย ย ย ย }
ย ย ย ย }
ย ย });
}

// ================= FUNCIONES DE REPORTE =================
function mostrarReporte(tipo) {
ย ย reporteActual = tipo;
ย ย document.getElementById('selectoresReportes').style.display = 'none';
ย ย const contenedor = document.getElementById('contenedorReporte');
ย ย const { fecha: fechaActual, turno: turnoActual } = obtenerTurnoActual();

ย ย let areaFiltroHtml = '';
ย ย const areas = ['TODAS', 'MULTIPORT', 'DROPS', 'BEDROCK', 'CALIDAD_MULTIPORT', 'CALIDAD_DROPS', 'CALIDAD_BEDROCK'];
ย ย areaFiltroHtml = `
ย ย ย ย <label for="areaFiltro">รrea:</label>
ย ย ย ย <select id="areaFiltro">
ย ย ย ย ย ย ${areas.map(area => `<option value="${area}">${area.replace('CALIDAD_', 'Calidad ')}</option>`).join('')}
ย ย ย ย </select>
ย ย `;

ย ย let empleadoFiltroHtml = '';
ย ย if (tipo === 'calidad') {
ย ย ย ย empleadoFiltroHtml = `
ย ย ย ย ย ย <label for="empleadoFiltro">Empleado:</label>
ย ย ย ย ย ย <input type="text" id="empleadoFiltro" placeholder="Nombre de Empleado">
ย ย ย ย `;
ย ย }

ย ย let fechaFiltroHtml = `<label for="fechaReporte">Fecha:</label><input type="date" id="fechaReporte" value="${fechaActual}">`;
ย ย let turnoFiltroHtml = `
ย ย ย ย <label for="turnoFiltro">Turno:</label>
ย ย ย ย <select id="turnoFiltro">
ย ย ย ย ย ย <option value="todos">Todos</option>
ย ย ย ย ย ย <option value="Turno 1">Turno 1</option>
ย ย ย ย ย ย <option value="Turno 2">Turno 2</option>
ย ย ย ย </select>
ย ย `;
ย ย let exportButtons = `
ย ย ย ย <button class="usuario-btn" onclick="exportarReporte('excel')">Exportar a Excel</button>
ย ย ย ย <button class="usuario-btn" onclick="exportarReporte('pdf')">Exportar a PDF</button>
ย ย ย ย <button class="usuario-btn" onclick="exportarReporte('csv')">Exportar a CSV</button>
ย ย `;

ย ย let graficoSelector = '';
ย ย if (tipo !== 'resumen') {
ย ย ย ย graficoSelector = `
ย ย ย ย ย ย <div class="opciones-grafico">
ย ย ย ย ย ย ย ย <label>Tipo de Grรกfico:</label>
ย ย ย ย ย ย ย ย <select id="tipoGrafico">
ย ย ย ย ย ย ย ย ย ย <option value="bar">Barras</option>
ย ย ย ย ย ย ย ย ย ย <option value="pie">Pastel</option>
ย ย ย ย ย ย ย ย ย ย <option value="line">Lรญnea</option>
ย ย ย ย ย ย ย ย </select>
ย ย ย ย ย ย </div>
ย ย ย ย `;
ย ย }

ย ย contenedor.innerHTML = `
ย ย ย ย <div class="header-reporte">
ย ย ย ย ย ย <button onclick="regresarASelectores()" class="usuario-btn">Regresar</button>
ย ย ย ย ย ย <div class="filtros">
ย ย ย ย ย ย ย ย ${fechaFiltroHtml}
ย ย ย ย ย ย ย ย ${turnoFiltroHtml}
ย ย ย ย ย ย ย ย ${tipo === 'resumen' ? '' : areaFiltroHtml}
ย ย ย ย ย ย ย ย ${empleadoFiltroHtml}
ย ย ย ย ย ย ย ย <button onclick="buscarReporte()" class="usuario-btn">Buscar</button>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย ย ย <h2 id="tituloReporteDinamico">Cargando...</h2>
ย ย ย ย ${graficoSelector}
ย ย ย ย <div id="contenidoReporte"></div>
ย ย ย ย <div class="botones-reporte">${exportButtons}</div>
ย ย `;

ย ย if (document.getElementById('turnoFiltro')) document.getElementById('turnoFiltro').value = turnoActual;
ย ย if (document.getElementById('areaFiltro')) document.getElementById('areaFiltro').value = 'TODAS';
ย ย if (document.getElementById('tipoGrafico')) document.getElementById('tipoGrafico').addEventListener('change', actualizarGraficoReporte);

ย ย cargarDatosReporte(tipo, document.getElementById('fechaReporte').value, document.getElementById('turnoFiltro').value, document.getElementById('areaFiltro')?.value, document.getElementById('empleadoFiltro')?.value);
}

function actualizarGraficoReporte() {
ย ย const tipoGraficoSeleccionado = document.getElementById('tipoGrafico').value;
ย ย const contenedorGrafico = document.querySelector('#grafico-contenedor');
ย ยย
ย ย if (contenedorGrafico) {
ย ย ย ย contenedorGrafico.innerHTML = '<canvas id="graficoDinamico"></canvas>';
ย ย }

ย ย if (datosFiltradosReporte) {
ย ย ย ย let labels, data, chartTitle;
ย ย ย ย if (reporteActual === 'produccion') {
ย ย ย ย ย ย const conteo = {};
ย ย ย ย ย ย datosFiltradosReporte.forEach(log => {
ย ย ย ย ย ย ย ย conteo[log.grupo] = (conteo[log.grupo] || 0) + 1;
ย ย ย ย ย ย });
ย ย ย ย ย ย labels = Object.keys(conteo);
ย ย ย ย ย ย data = Object.values(conteo);
ย ย ย ย ย ย chartTitle = 'Tarimas Producidas por รrea';
ย ย ย ย } else if (reporteActual === 'logistica') {
ย ย ย ย ย ย const conteo = {};
ย ย ย ย ย ย datosFiltradosReporte.forEach(log => {
ย ย ย ย ย ย ย ย conteo[log.grupo] = (conteo[log.grupo] || 0) + 1;
ย ย ย ย ย ย });
ย ย ย ย ย ย labels = Object.keys(conteo);
ย ย ย ย ย ย data = Object.values(conteo);
ย ย ย ย ย ย chartTitle = 'Total de Tarimas Recolectadas por รrea';
ย ย ย ย } else if (reporteActual === 'calidad') {
ย ย ย ย ย ย const conteo = {};
ย ย ย ย ย ย datosFiltradosReporte.forEach(rechazo => {
ย ย ย ย ย ย ย ย conteo[rechazo.problema] = (conteo[rechazo.problema] || 0) + 1;
ย ย ย ย ย ย });
ย ย ย ย ย ย labels = Object.keys(conteo);
ย ย ย ย ย ย data = Object.values(conteo);
ย ย ย ย ย ย chartTitle = 'Causas de Rechazo';
ย ย ย ย }

ย ย ย ย if (miGrafico) miGrafico.destroy();

ย ย ย ย const ctx = document.getElementById('graficoDinamico').getContext('2d');
ย ย ย ย const backgroundColors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#E7E9ED', '#FF6361', '#5DADE2', '#F7DC6F', '#7DCEA0', '#AF7AC5', '#F5B041'];

ย ย ย ย miGrafico = new Chart(ctx, {
ย ย ย ย ย ย type: tipoGraficoSeleccionado,
ย ย ย ย ย ย data: {
ย ย ย ย ย ย ย ย labels: labels,
ย ย ย ย ย ย ย ย datasets: [{
ย ย ย ย ย ย ย ย ย ย label: chartTitle,
ย ย ย ย ย ย ย ย ย ย data: data,
ย ย ย ย ย ย ย ย ย ย backgroundColor: backgroundColors,
ย ย ย ย ย ย ย ย ย ย borderColor: backgroundColors,
ย ย ย ย ย ย ย ย ย ย borderWidth: 1,
ย ย ย ย ย ย ย ย ย ย fill: tipoGraficoSeleccionado === 'line',
ย ย ย ย ย ย ย ย ย ย tension: 0.4
ย ย ย ย ย ย ย ย }]
ย ย ย ย ย ย },
ย ย ย ย ย ย options: {
ย ย ย ย ย ย ย ย responsive: true,
ย ย ย ย ย ย ย ย plugins: {
ย ย ย ย ย ย ย ย ย ย legend: { position: 'top', labels: { font: { size: 14 } } },
ย ย ย ย ย ย ย ย ย ย title: { display: true, text: chartTitle, font: { size: 20 } }
ย ย ย ย ย ย ย ย },
ย ย ย ย ย ย ย ย scales: { y: { beginAtZero: true } }
ย ย ย ย ย ย }
ย ย ย ย });
ย ย }
}


function regresarASelectores() {
ย ย document.getElementById('tituloReportes').textContent = 'REPORTES';
ย ย document.getElementById('selectoresReportes').style.display = 'flex';
ย ย document.getElementById('contenedorReporte').innerHTML = '<h2>Selecciona un reporte</h2>';
ย ย if (miGrafico) miGrafico.destroy();
ย ย datosFiltradosReporte = null;
}

function buscarReporte() {
ย ย const tipo = reporteActual;
ย ย const fecha = document.getElementById('fechaReporte').value;
ย ย const turno = document.getElementById('turnoFiltro').value;
ย ย const area = document.getElementById('areaFiltro') ? document.getElementById('areaFiltro').value : null;
ย ย const empleado = document.getElementById('empleadoFiltro') ? document.getElementById('empleadoFiltro').value : null;

ย ย cargarDatosReporte(tipo, fecha, turno, area, empleado);
}


function cargarDatosReporte(tipo, fecha, turno, area, empleado) {
ย ย const contenedor = document.getElementById('contenidoReporte');
ย ย const tituloReporte = document.getElementById('tituloReporteDinamico');
ย ย contenedor.innerHTML = '<p>Cargando datos...</p>';
ย ยย
ย ย if (miGrafico) miGrafico.destroy();
ย ยย
ย ย const refHistorial = db.ref(`historialLogs`);
ย ย const refCalidad = db.ref(`contadoresCalidad`);
ย ย const refRechazos = db.ref(`rechazosDetallados`);

ย ย Promise.all([
ย ย ย ย refHistorial.once('value').then(s => s.val()),
ย ย ย ย refCalidad.once('value').then(s => s.val()),
ย ย ย ย refRechazos.once('value').then(s => s.val())
ย ย ]).then(([historial, calidad, rechazos]) => {
ย ย ย ย const datosCompletos = { historial, calidad, rechazos };
ย ย ย ยย
ย ย ย ย if (tipo === 'calidad') {
ย ย ย ย ย ย tituloReporte.textContent = `Reporte de Calidad - ${fecha}`;
ย ย ย ย ย ย procesarReporteCalidad(datosCompletos, contenedor, fecha, turno, area, empleado);
ย ย ย ย } else if (tipo === 'produccion') {
ย ย ย ย ย ย tituloReporte.textContent = `Reporte de Producciรณn - ${fecha}`;
ย ย ย ย ย ย procesarReporteProduccion(datosCompletos, contenedor, fecha, turno, area);
ย ย ย ย } else if (tipo === 'logistica') {
ย ย ย ย ย ย tituloReporte.textContent = `Reporte de Logรญstica - ${fecha}`;
ย ย ย ย ย ย procesarReporteLogistica(datosCompletos, contenedor, fecha, turno, area);
ย ย ย ย } else if (tipo === 'resumen') {
ย ย ย ย ย ย tituloReporte.textContent = `Resumen Ejecutivo`;
ย ย ย ย ย ย procesarReporteResumen(datosCompletos, contenedor, fecha, turno);
ย ย ย ย }
ย ย }).catch(error => {
ย ย ย ย console.error("Error al cargar los datos:", error);
ย ย ย ย contenedor.innerHTML = `<p>Error al cargar los datos. Intenta de nuevo.</p>`;
ย ย });
}


function procesarReporteCalidad(datos, contenedor, fecha, turno, area, empleado) {
ย ย let rechazosFiltrados = [];
ย ยย
ย ย for (const fechaKey in datos.rechazos) {
ย ย ย ย if (fecha !== fechaKey) continue;
ย ย ย ย for (const turnoKey in datos.rechazos[fechaKey]) {
ย ย ย ย ย ย if (turno !== 'todos' && turnoKey !== turno) continue;
ย ย ย ย ย ย for (const rechazoKey in datos.rechazos[fechaKey][turnoKey]) {
ย ย ย ย ย ย ย ย const rechazo = datos.rechazos[fechaKey][turnoKey][rechazoKey];
ย ย ย ย ย ย ย ย if (
ย ย ย ย ย ย ย ย ย ย (area === 'TODAS' || rechazo.areaRechazo === area) &&
ย ย ย ย ย ย ย ย ย ย (!empleado || (rechazo.empleado && rechazo.empleado.toLowerCase().includes(empleado.toLowerCase())))
ย ย ย ย ย ย ย ย ) {
ย ย ย ย ย ย ย ย ย ย rechazosFiltrados.push(rechazo);
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย }
ย ย }
ย ยย
ย ย datosFiltradosReporte = rechazosFiltrados;

ย ย const conteoProblemas = {};
ย ย rechazosFiltrados.forEach(r => { conteoProblemas[r.problema || 'Desconocido'] = (conteoProblemas[r.problema || 'Desconocido'] || 0) + 1; });

ย ย const kpisHtml = `<div class="resumen-datos"><div class="dato"><div class="valor">${rechazosFiltrados.length}</div><div class="etiqueta">Tarimas Rechazadas</div></div><div class="dato"><div class="valor">${Object.keys(conteoProblemas).length}</div><div class="etiqueta">Problemas Identificados</div></div></div>`;
ย ยย
ย ย let tablaHtml = `<table><thead><tr><th>Fecha</th><th>Hora</th><th>รrea</th><th>Lรญnea</th><th>Empleado</th><th>No. de Parte</th><th>Descripciรณn de la Parte</th><th>Descripciรณn del Problema</th><th>Causa Raรญz</th><th>Acciรณn Correctiva</th></tr></thead><tbody>`;
ย ย rechazosFiltrados.forEach(r => {
ย ย ย ย const areaFmt = r.areaRechazo ? r.areaRechazo.replace('CALIDAD_', '') : 'N/A';
ย ย ย ย tablaHtml += `<tr><td>${r.fecha}</td><td>${r.hora}</td><td>${areaFmt}</td><td>${r.linea||'N/A'}</td><td>${r.empleado||'N/A'}</td><td>${r.parte||'N/A'}</td><td>${r.descripcionParte||'N/A'}</td><td>${r.problema||'N/A'}</td><td>${r.causa||'N/A'}</td><td>${r.accion||'N/A'}</td></tr>`;
ย ย });
ย ย tablaHtml += `</tbody></table>`;

ย ย let tablaMovilHtml = `<div class="reporte-calidad-mobile"><div class="tabla-calidad-movil">`;
ย ย rechazosFiltrados.forEach(r => {
ย ย ย ย const areaFmt = r.areaRechazo ? r.areaRechazo.replace('CALIDAD_', '') : 'N/A';
ย ย ย ย tablaMovilHtml += `<div class="fila-dato"><span class="etiqueta">Fecha:</span> <span class="valor">${r.fecha}</span><br><span class="etiqueta">Hora:</span> <span class="valor">${r.hora}</span><br><span class="etiqueta">รrea:</span> <span class="valor">${areaFmt}</span><br><span class="etiqueta">Lรญnea:</span> <span class="valor">${r.linea||'N/A'}</span><br><span class="etiqueta">Empleado:</span> <span class="valor">${r.empleado||'N/A'}</span><br><span class="etiqueta">Problema:</span> <span class="valor">${r.problema||'N/A'}</span></div>`;
ย ย });
ย ย tablaMovilHtml += `</div></div>`;

ย ย let graficoHtml = Object.keys(conteoProblemas).length > 0 ? `<div id="grafico-contenedor" class="grafico-contenedor"><canvas id="graficoDinamico"></canvas></div>` : '';
ย ย contenedor.innerHTML = kpisHtml + graficoHtml + tablaHtml + tablaMovilHtml;

ย ย if (Object.keys(conteoProblemas).length > 0) actualizarGraficoReporte();
}


function procesarReporteProduccion(datos, contenedor, fecha, turno, area) {
ย ย let logsProduccion = [];
ย ย const conteo = { MULTIPORT: 0, DROPS: 0, BEDROCK: 0 };
ย ยย
ย ย for (const fechaKey in datos.historial) {
ย ย ย ย if (fecha !== fechaKey) continue;
ย ย ย ย for (const turnoKey in datos.historial[fechaKey]) {
ย ย ย ย ย ย if (turno !== 'todos' && turnoKey !== turno) continue;
ย ย ย ย ย ย for (const logKey in datos.historial[fechaKey][turnoKey]) {
ย ย ย ย ย ย ย ย const log = datos.historial[fechaKey][turnoKey][logKey];
ย ย ย ย ย ย ย ย if (log.accion === 'encendido' && ['MULTIPORT', 'DROPS', 'BEDROCK'].includes(log.grupo)) {
ย ย ย ย ย ย ย ย ย ย if (area === 'TODAS' || log.grupo === area) {
ย ย ย ย ย ย ย ย ย ย ย ย logsProduccion.push(log);
ย ย ย ย ย ย ย ย ย ย ย ย conteo[log.grupo]++;
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย }
ย ย }
ย ยย
ย ย datosFiltradosReporte = logsProduccion;

ย ย const kpisHtml = `<div class="resumen-datos"><div class="dato"><div class="valor">${logsProduccion.length}</div><div class="etiqueta">Tarimas Confirmadas</div></div></div>`;
ย ย const graficoHtml = `<div id="grafico-contenedor" class="grafico-contenedor"><canvas id="graficoDinamico"></canvas></div>`;

ย ย let tablaHtml = `<table><thead><tr><th>Lรญnea</th><th>Tarima</th><th>Hora de Confirmaciรณn</th><th>Usuario</th></tr></thead><tbody>`;
ย ย logsProduccion.forEach(log => { tablaHtml += `<tr><td>${log.grupo}</td><td>${log.led}</td><td>${formatoHora(log.timestamp)}</td><td>${log.usuario}</td></tr>`; });
ย ย tablaHtml += `</tbody></table>`;
ย ยย
ย ย let tablaMovilHtml = `<div class="reporte-calidad-mobile"><div class="tabla-calidad-movil">`;
ย ย logsProduccion.forEach(log => { tablaMovilHtml += `<div class="fila-dato"><span class="etiqueta">Lรญnea:</span><span class="valor">${log.grupo}</span><br><span class="etiqueta">Tarima:</span><span class="valor">${log.led}</span><br><span class="etiqueta">Hora:</span><span class="valor">${formatoHora(log.timestamp)}</span><br><span class="etiqueta">Usuario:</span><span class="valor">${log.usuario}</span></div>`; });
ย ย tablaMovilHtml += `</div></div>`;

ย ย contenedor.innerHTML = kpisHtml + graficoHtml + tablaHtml + tablaMovilHtml;
ย ย actualizarGraficoReporte();
}


function procesarReporteLogistica(datos, contenedor, fecha, turno, area) {
ย ย let logsRecoleccion = [];
ย ย let tiempoTotal = 0;
ย ยย
ย ย for (const fechaKey in datos.historial) {
ย ย ย ย if (fecha !== fechaKey) continue;
ย ย ย ย for (const turnoKey in datos.historial[fechaKey]) {
ย ย ย ย ย ย if (turno !== 'todos' && turnoKey !== turno) continue;
ย ย ย ย ย ย for (const logKey in datos.historial[fechaKey][turnoKey]) {
ย ย ย ย ย ย ย ย const log = datos.historial[fechaKey][turnoKey][logKey];
ย ย ย ย ย ย ย ย if (log.accion === 'apagado' && log.tiempoRecoleccion && ['MULTIPORT', 'DROPS', 'BEDROCK'].includes(log.grupo)) {
ย ย ย ย ย ย ย ย ย ย if (area === 'TODAS' || log.grupo === area) {
ย ย ย ย ย ย ย ย ย ย ย ย logsRecoleccion.push(log);
ย ย ย ย ย ย ย ย ย ย ย ย tiempoTotal += log.tiempoRecoleccion;
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย }
ย ย }

ย ย datosFiltradosReporte = logsRecoleccion;
ย ยย
ย ย const tiempoPromedio = logsRecoleccion.length > 0 ? (tiempoTotal / logsRecoleccion.length).toFixed(1) : 0;
ย ยย
ย ย const kpisHtml = `<div class="resumen-datos"><div class="dato"><div class="valor">${logsRecoleccion.length}</div><div class="etiqueta">Tarimas Recolectadas</div></div><div class="dato"><div class="valor">${tiempoPromedio} min</div><div class="etiqueta">Tiempo Promedio</div></div></div>`;
ย ย const graficoHtml = `<div id="grafico-contenedor" class="grafico-contenedor"><canvas id="graficoDinamico"></canvas></div>`;

ย ย let tablaHtml = `<table><thead><tr><th>Lรญnea</th><th>Tarima</th><th>Tiempo de Recolecciรณn (min)</th><th>Hora de Encendido</th><th>Hora de Apagado</th></tr></thead><tbody>`;
ย ย logsRecoleccion.forEach(log => { tablaHtml += `<tr><td>${log.grupo}</td><td>${log.led}</td><td>${log.tiempoRecoleccion}</td><td>${formatoHora(log.horaEncendido)}</td><td>${formatoHora(log.horaApagado)}</td></tr>`; });
ย ย tablaHtml += `</tbody></table>`;
ย ยย
ย ย let tablaMovilHtml = `<div class="reporte-calidad-mobile"><div class="tabla-calidad-movil">`;
ย ย logsRecoleccion.forEach(log => { tablaMovilHtml += `<div class="fila-dato"><span class="etiqueta">Lรญnea:</span> <span class="valor">${log.grupo}</span><br><span class="etiqueta">Tarima:</span> <span class="valor">${log.led}</span><br><span class="etiqueta">Tiempo:</span> <span class="valor">${log.tiempoRecoleccion} min</span><br><span class="etiqueta">Hora de Recolecciรณn:</span> <span class="valor">${formatoHora(log.horaApagado)}</span></div>`; });
ย ย tablaMovilHtml += `</div></div>`;

ย ย contenedor.innerHTML = kpisHtml + graficoHtml + tablaHtml + tablaMovilHtml;
ย ย document.getElementById('tipoGrafico').value = 'bar';
ย ย actualizarGraficoReporte();
}

function procesarReporteResumen(datos, contenedor, fecha, turno) {
ย ย const areas = ['MULTIPORT', 'DROPS', 'BEDROCK'];
ย ย const resumen = {};
ย ยย
ย ย areas.forEach(area => { resumen[area] = { produccion: 0, liberadas: 0, rechazadas: 0, tiempoLogistica: { total: 0, count: 0, promedio: 0 } }; });

ย ย for (const fechaKey in datos.historial) {
ย ย ย ย if (fechaKey !== fecha && fecha !== null) continue;
ย ย ย ย for (const turnoKey in datos.historial[fechaKey]) {
ย ย ย ย ย ย if (turnoKey !== turno && turno !== 'todos') continue;
ย ย ย ย ย ย for (const logKey in datos.historial[fechaKey][turnoKey]) {
ย ย ย ย ย ย ย ย const log = datos.historial[fechaKey][turnoKey][logKey];
ย ย ย ย ย ย ย ย if (log.accion === 'encendido' && resumen.hasOwnProperty(log.grupo)) {
ย ย ย ย ย ย ย ย ย ย resumen[log.grupo].produccion++;
ย ย ย ย ย ย ย ย } else if (log.accion === 'apagado' && log.tiempoRecoleccion && resumen.hasOwnProperty(log.grupo)) {
ย ย ย ย ย ย ย ย ย ย resumen[log.grupo].tiempoLogistica.total += log.tiempoRecoleccion;
ย ย ย ย ย ย ย ย ย ย resumen[log.grupo].tiempoLogistica.count++;
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย }
ย ย }

ย ย for (const fechaKey in datos.calidad) {
ย ย ย ย if (fechaKey !== fecha && fecha !== null) continue;
ย ย ย ย for (const turnoKey in datos.calidad[fechaKey]) {
ย ย ย ย ย ย if (turnoKey !== turno && turno !== 'todos') continue;
ย ย ย ย ย ย for (const grupoKey in datos.calidad[fechaKey][turnoKey]) {
ย ย ย ย ย ย ย ย const grupoBase = grupoKey.replace('CALIDAD_', '');
ย ย ย ย ย ย ย ย if (resumen.hasOwnProperty(grupoBase)) {
ย ย ย ย ย ย ย ย ย ย const contadores = datos.calidad[fechaKey][turnoKey][grupoKey];
ย ย ย ย ย ย ย ย ย ย resumen[grupoBase].liberadas += contadores.liberadas || 0;
ย ย ย ย ย ย ย ย ย ย resumen[grupoBase].rechazadas += contadores.rechazadas || 0;
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย }
ย ย }

ย ย let html = ``;
ย ย areas.forEach(area => {
ย ย ย ย const { produccion, liberadas, rechazadas, tiempoLogistica } = resumen[area];
ย ย ย ย const totalCalidad = liberadas + rechazadas;
ย ย ย ย const tasaRechazo = totalCalidad > 0 ? ((rechazadas / totalCalidad) * 100).toFixed(1) : 0;
ย ย ย ย const tiempoPromedio = tiempoLogistica.count > 0 ? (tiempoLogistica.total / tiempoLogistica.count).toFixed(1) : 0;

ย ย ย ย html += `<h3>${area}</h3><div class="resumen-datos"><div class="dato"><div class="valor">${produccion}</div><div class="etiqueta">Producidas</div></div><div class="dato"><div class="valor">${liberadas}</div><div class="etiqueta">Liberadas</div></div><div class="dato"><div class="valor">${rechazadas}</div><div class="etiqueta">Rechazadas</div></div><div class="dato"><div class="valor">${tasaRechazo}%</div><div class="etiqueta">Tasa Rechazo</div></div><div class="dato"><div class="valor">${tiempoPromedio} min</div><div class="etiqueta">T. Recolecciรณn</div></div></div>`;
ย ย });
ย ย contenedor.innerHTML = html;
}

async function exportarReporte(formato) {
ย ย const tabla = document.querySelector('#contenidoReporte table');
ย ย if (!tabla) {
ย ย ย ย return await customAlert('No hay datos para exportar. Por favor, genera un reporte primero.', 'Exportaciรณn Fallida');
ย ย }
ย ย const chart = miGrafico;
ย ย const tipo = reporteActual;
ย ย const nombreArchivo = `${tipo}_${document.getElementById('fechaReporte').value}`;

ย ย if (formato === 'excel') {
ย ย ย ย const data = XLSX.utils.table_to_sheet(tabla);
ย ย ย ย const wb = XLSX.utils.book_new();
ย ย ย ย XLSX.utils.book_append_sheet(wb, data, 'Reporte');
ย ย ย ย XLSX.writeFile(wb, `${nombreArchivo}.xlsx`);
ย ย } else if (formato === 'pdf') {
ย ย ย ย exportarAPdf(tabla, chart, nombreArchivo);
ย ย } else if (formato === 'csv') {
ย ย ย ย exportarACsv(tabla, nombreArchivo);
ย ย }
}

function exportarACsv(tabla, nombreReporte) {
ย ย let csv = [];
ย ย tabla.querySelectorAll('tr').forEach(fila => {
ย ย ย ย let filaDatos = [];
ย ย ย ย fila.querySelectorAll('th, td').forEach(celda => {
ย ย ย ย ย ย filaDatos.push(`"${celda.textContent.trim().replace(/"/g, '""')}"`);
ย ย ย ย });
ย ย ย ย csv.push(filaDatos.join(','));
ย ย });
ย ย const blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
ย ย const link = document.createElement('a');
ย ย link.href = URL.createObjectURL(blob);
ย ย link.download = `${nombreReporte}.csv`;
ย ย link.click();
ย ย URL.revokeObjectURL(link.href);
}

function exportarAPdf(tabla, chart, nombreArchivo) {
ย ย const { jsPDF } = window.jspdf;
ย ย const doc = new jsPDF('p', 'pt', 'letter');
ย ย const margin = 20;
ย ย let y = margin;
ย ย let pageWidth = doc.internal.pageSize.width || doc.internal.pageSize.getWidth();

ย ย doc.setFontSize(22);
ย ย doc.text(`Reporte de ${reporteActual.toUpperCase()}`, pageWidth / 2, y, { align: 'center' });
ย ย y += 30;
ย ย doc.setFontSize(12);
ย ย doc.text(`Fecha: ${document.getElementById('fechaReporte').value}`, margin, y);
ย ย y += 20;

ย ย const resumenDiv = document.querySelector('#contenidoReporte .resumen-datos');
ย ย if (resumenDiv) {
ย ย ย ย const resumenText = Array.from(resumenDiv.children).map(dato => `${dato.querySelector('.etiqueta').textContent}: ${dato.querySelector('.valor').textContent}`).join('ย |ย ');
ย ย ย ย doc.text(resumenText, margin, y);
ย ย ย ย y += 30;
ย ย }

ย ย if (chart) {
ย ย ย ย const chartDataURL = chart.toBase64Image();
ย ย ย ย const imgWidth = 500;
ย ย ย ย const imgHeight = 250;
ย ย ย ย const imgX = (pageWidth - imgWidth) / 2;
ย ย ย ย if (y + imgHeight + 30 > doc.internal.pageSize.height) { doc.addPage(); y = margin; }
ย ย ย ย doc.addImage(chartDataURL, 'PNG', imgX, y, imgWidth, imgHeight);
ย ย ย ย y += imgHeight + 30;
ย ย }

ย ย doc.autoTable({
ย ย ย ย startY: y,
ย ย ย ย html: tabla,
ย ย ย ย theme: 'striped',
ย ย ย ย styles: { fontSize: 8, cellPadding: 5 },
ย ย });

ย ย doc.save(`${nombreArchivo}.pdf`);
}
// ==========================================================

// ================= ARRANQUE Y MANEJO DE MODALES =================
window.addEventListener('load', ()=>{
ย ย firebase.auth().signInAnonymously().catch(err => console.error('Auth error:', err));
ย ยย
ย ย firebase.auth().onAuthStateChanged(user => {
ย ย ย ย if (user) {
ย ย ย ย ย ย iniciarListenersFirebase();ย
ย ย ย ย }
ย ย });

ย ย setTimeout(() => {
ย ย ย ย const splash = document.getElementById('splashScreen');
ย ย ย ย splash.style.opacity = '0';
ย ย ย ย splash.addEventListener('transitionend', () => {
ย ย ย ย ย ย splash.classList.remove('activa');
ย ย ย ย ย ย activarPantalla('pantalla1');
ย ย ย ย }, { once: true });
ย ย }, 3000);
ย ยย
ย ย const modalCalidad = document.getElementById('modalCalidad');
ย ย modalCalidad.querySelector('.cerrar-btn').addEventListener('click', () => modalCalidad.classList.remove('visible'));
ย ย modalCalidad.querySelectorAll('.opcion-btn').forEach(btn => {
ย ย ย ย btn.addEventListener('click', () => {
ย ย ย ย ย ย const nuevoColor = btn.dataset.color;
ย ย ย ย ย ย if (nuevoColor === 'rojo') {
ย ย ย ย ย ย ย ย mostrarFormularioRechazo();
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย aplicarEstadoCalidad(nuevoColor);
ย ย ย ย ย ย ย ย modalCalidad.classList.remove('visible');
ย ย ย ย ย ย }
ย ย ย ย });
ย ย });

ย ย const modalRechazo = document.getElementById('modalRechazo');
ย ย const formRechazo = document.getElementById('formularioRechazo');
ย ยย
ย ย formRechazo.addEventListener('submit', (e) => {
ย ย ย ย e.preventDefault();
ย ย ย ย const datos = {
ย ย ย ย ย ย empleado: formRechazo.empleado.value,
ย ย ย ย ย ย linea: formRechazo.linea.value,
ย ย ย ย ย ย parte: formRechazo.parte.value,
ย ย ย ย ย ย descripcionParte: formRechazo.descripcionParte.value,
ย ย ย ย ย ย problema: formRechazo.problema.value,
ย ย ย ย ย ย causa: formRechazo.causa.value,
ย ย ย ย ย ย accion: formRechazo.accion.value,
ย ย ย ย };
ย ย ย ย guardarRechazo(datos);
ย ย ย ย formRechazo.reset();
ย ย });

ย ย document.getElementById('cancelRechazo').addEventListener('click', () => {
ย ย ย ย modalRechazo.classList.remove('visible');
ย ย ย ย formRechazo.reset();
ย ย });

ย ย document.getElementById('selectoresReportes').querySelectorAll('.usuario-btn').forEach(btn => {
ย ย ย ย btn.addEventListener('click', () => mostrarReporte(btn.dataset.reporte));
ย ย });

ย ย if ('serviceWorker' in navigator) {
ย ย ย ย navigator.serviceWorker.register('./sw.js').then(reg => console.log("โ Service Worker registrado:", reg)).catch(err => console.error("โ Error al registrar Service Worker:", err));
ย ย }
ย ยย
ย ย // === MEJORA: Iniciar el actualizador de contadores global ===
ย ย setInterval(actualizarTodosLosContadores, 10000); // Actualiza cada 10 segundos
});
</script>
</body>
</html>
